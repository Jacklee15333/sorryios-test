/**
 * Bug 27 + Bug 28 ä¿®å¤æµ‹è¯•è„šæœ¬
 * ================================
 * Bug 27: grammarCoreTerms ä¸­ 'è¿‡å»åˆ†è¯' é‡å¤ï¼ˆç¬¬180è¡Œå’Œç¬¬190è¡Œï¼‰
 * Bug 28: calculateChineseSimilarity ç­–ç•¥1ç¼ºå°‘è¾“å…¥æœ¯è¯­è¦†ç›–ç‡æ£€æŸ¥
 *         å¯¼è‡´ "å½¢å®¹è¯ä½œè¡¨è¯­" é”™è¯¯åŒ¹é…åˆ° "éè°“è¯­"(89%)
 * 
 * è¿è¡Œæ–¹å¼:
 *   cd D:\sorryios-test\backend
 *   node tests\test-bug-27-28.js
 * 
 * éœ€è¦: better-sqlite3, å®é™…æ•°æ®åº“æ–‡ä»¶åœ¨ data/ ç›®å½•
 */

const path = require('path');

// ============ é…ç½® ============
const PROJECT_ROOT = path.resolve(__dirname, '..');
const DATA_DIR = path.join(PROJECT_ROOT, 'data');

// ============ åŠ è½½æœåŠ¡ ============
let matchingService;
try {
    // å°è¯•åŠ è½½ matchingServiceï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
    const { getMatchingService } = require(path.join(PROJECT_ROOT, 'services', 'matchingService'));
    matchingService = getMatchingService();
    console.log('âœ… matchingService åŠ è½½æˆåŠŸ');
} catch (e) {
    console.error(`âŒ æ— æ³•åŠ è½½ matchingService: ${e.message}`);
    console.error('   è¯·ç¡®ä¿åœ¨ D:\\sorryios-test\\backend ç›®å½•ä¸‹è¿è¡Œ');
    process.exit(1);
}

// ============ æµ‹è¯•æ¡†æ¶ ============
let passed = 0;
let failed = 0;
let errors = [];

function assert(condition, testName, detail = '') {
    if (condition) {
        passed++;
        console.log(`  âœ… ${testName}`);
    } else {
        failed++;
        const msg = `  âŒ ${testName}${detail ? ' | ' + detail : ''}`;
        console.log(msg);
        errors.push(msg);
    }
}

function assertScoreBelow(input, target, threshold, testName) {
    try {
        const result = matchingService.calculateChineseSimilarity(input, target);
        const score = result.score;
        const detail = `score=${(score*100).toFixed(1)}% åº”<${threshold*100}% reason="${result.reason}"`;
        assert(score < threshold, testName, detail);
    } catch (e) {
        failed++;
        const msg = `  âŒ ${testName} | å¼‚å¸¸: ${e.message}`;
        console.log(msg);
        errors.push(msg);
    }
}

function assertScoreAbove(input, target, threshold, testName) {
    try {
        const result = matchingService.calculateChineseSimilarity(input, target);
        const score = result.score;
        const detail = `score=${(score*100).toFixed(1)}% åº”>=${threshold*100}% reason="${result.reason}"`;
        assert(score >= threshold, testName, detail);
    } catch (e) {
        failed++;
        const msg = `  âŒ ${testName} | å¼‚å¸¸: ${e.message}`;
        console.log(msg);
        errors.push(msg);
    }
}

function assertScoreRange(input, target, min, max, testName) {
    try {
        const result = matchingService.calculateChineseSimilarity(input, target);
        const score = result.score;
        const detail = `score=${(score*100).toFixed(1)}% åº”åœ¨${min*100}%-${max*100}% reason="${result.reason}"`;
        assert(score >= min && score <= max, testName, detail);
    } catch (e) {
        failed++;
        const msg = `  âŒ ${testName} | å¼‚å¸¸: ${e.message}`;
        console.log(msg);
        errors.push(msg);
    }
}

// ============ å¼€å§‹æµ‹è¯• ============
console.log('\n' + '='.repeat(70));
console.log('  Bug 27 + Bug 28 ä¿®å¤æµ‹è¯• â€” å…±40ä¸ªæµ‹è¯•ç”¨ä¾‹');
console.log('='.repeat(70));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¬¬ä¸€ç»„ (10ä¸ª): Bug 28 æ ¸å¿ƒåœºæ™¯ â€” é”™è¯¯åŒ¹é…åº”è¢«é˜»æ­¢
// è¿™äº›æ˜¯æ­¤æ¬¡ä¿®å¤ç›´æ¥è§£å†³çš„é—®é¢˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
console.log('\nâ”€â”€ ç¬¬1ç»„: Bug 28 æ ¸å¿ƒåœºæ™¯ â€” é”™è¯¯åŒ¹é…åº”è¢«é˜»æ­¢ (10ä¸ª) â”€â”€');

// æµ‹è¯•1-2: åŸå§‹ bug åœºæ™¯
assertScoreBelow('å½¢å®¹è¯å’Œå‰¯è¯çš„åŒºåˆ«', 'è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯', 0.85,
    '#01 "å½¢å®¹è¯å’Œå‰¯è¯çš„åŒºåˆ«" vs "è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯" åº”<85%');

assertScoreBelow('å½¢å®¹è¯ä½œè¡¨è¯­', 'è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯', 0.85,
    '#02 "å½¢å®¹è¯ä½œè¡¨è¯­" vs "è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯" åº”<85%');

// æµ‹è¯•3-4: æ­¥éª¤4ä¸­çš„éšè—é”™è¯¯åŒ¹é…
assertScoreBelow('å½¢å®¹è¯å’Œå‰¯è¯çš„åŒºåˆ«', 'å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§', 0.85,
    '#03 "å½¢å®¹è¯å’Œå‰¯è¯çš„åŒºåˆ«" vs "å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§" åº”<85% (æ¦‚å¿µä¸åŒ)');

assertScoreBelow('å½¢å®¹è¯ä½œè¡¨è¯­', 'å½¢å®¹è¯ç”¨æ³•', 0.85,
    '#04 "å½¢å®¹è¯ä½œè¡¨è¯­" vs "å½¢å®¹è¯ç”¨æ³•" åº”<85% (è¡¨è¯­æœªåŒ¹é…)');

// æµ‹è¯•5-6: ä»å¥é”™è¯¯åŒ¹é…
assertScoreBelow('å®¾è¯­ä»å¥çš„ç”¨æ³•', 'å®šè¯­ä»å¥', 0.85,
    '#05 "å®¾è¯­ä»å¥çš„ç”¨æ³•" vs "å®šè¯­ä»å¥" åº”<85% (ä¸åŒä»å¥ç±»å‹)');

assertScoreBelow('çŠ¶è¯­ä»å¥å’Œå®šè¯­ä»å¥', 'å®¾è¯­ä»å¥', 0.85,
    '#06 "çŠ¶è¯­ä»å¥å’Œå®šè¯­ä»å¥" vs "å®¾è¯­ä»å¥" åº”<85%');

// æµ‹è¯•7-8: åŠ¨è¯ç›¸å…³é”™è¯¯åŒ¹é…
assertScoreBelow('åŠ¨åè¯ä½œä¸»è¯­', 'ä¸å®šå¼', 0.85,
    '#07 "åŠ¨åè¯ä½œä¸»è¯­" vs "ä¸å®šå¼" åº”<85% (ä¸åŒéè°“è¯­)');

assertScoreBelow('è¿‡å»åˆ†è¯ä½œå®šè¯­', 'ç°åœ¨åˆ†è¯ (v.-ingä½œå½¢å®¹è¯/å‰¯è¯)', 0.85,
    '#08 "è¿‡å»åˆ†è¯ä½œå®šè¯­" vs "ç°åœ¨åˆ†è¯" åº”<85%');

// æµ‹è¯•9-10: å…¶ä»–ä¸ç²¾ç¡®åœºæ™¯
assertScoreBelow('åŠ¨è¯è¿‡å»å¼å˜åŒ–', 'åŠ¨è¯è¿‡å»å¼ä¸è¿‡å»åˆ†è¯çš„åŒºåˆ«', 0.85,
    '#09 "åŠ¨è¯è¿‡å»å¼å˜åŒ–" vs "åŠ¨è¯è¿‡å»å¼ä¸è¿‡å»åˆ†è¯çš„åŒºåˆ«" åº”<85%');

assertScoreBelow('åè¯å’ŒåŠ¨è¯çš„åŒºåˆ«', 'åè¯å•å¤æ•°', 0.85,
    '#10 "åè¯å’ŒåŠ¨è¯çš„åŒºåˆ«" vs "åè¯å•å¤æ•°" åº”<85%');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¬¬äºŒç»„ (10ä¸ª): æ­£ç¡®åŒ¹é…ä¸åº”è¢«ç ´å
// ç¡®ä¿ä¿®å¤æ²¡æœ‰è¯¯ä¼¤
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
console.log('\nâ”€â”€ ç¬¬2ç»„: æ­£ç¡®åŒ¹é…ä¸åº”è¢«ç ´å (10ä¸ª) â”€â”€');

// æµ‹è¯•11-12: è¾“å…¥åªæœ‰1ä¸ªæ ¸å¿ƒæœ¯è¯­ æˆ– ç›®æ ‡æ˜¯è¾“å…¥å­ä¸²ï¼ˆä¸è§¦å‘æƒ©ç½šï¼‰
assertScoreAbove('æ¯”è¾ƒçº§çš„ç”¨æ³•', 'å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§', 0.85,
    '#11 "æ¯”è¾ƒçº§çš„ç”¨æ³•" vs "å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§" åº”>=85%');

assertScoreAbove('éè°“è¯­åŠ¨è¯', 'éè°“è¯­', 0.85,
    '#12 "éè°“è¯­åŠ¨è¯" vs "éè°“è¯­" åº”>=85% (ç›®æ ‡æ˜¯è¾“å…¥æ ¸å¿ƒå­ä¸²ï¼Œè·³è¿‡æƒ©ç½š)');

// æµ‹è¯•13-14: å®Œå…¨ç›¸åŒ
assertScoreAbove('ä¸€èˆ¬ç°åœ¨æ—¶', 'ä¸€èˆ¬ç°åœ¨æ—¶', 0.98,
    '#13 "ä¸€èˆ¬ç°åœ¨æ—¶" vs "ä¸€èˆ¬ç°åœ¨æ—¶" åº”>=98% (å®Œå…¨ç›¸åŒ)');

assertScoreAbove('è¢«åŠ¨è¯­æ€', 'è¢«åŠ¨è¯­æ€', 0.98,
    '#14 "è¢«åŠ¨è¯­æ€" vs "è¢«åŠ¨è¯­æ€" åº”>=98%');

// æµ‹è¯•15-16: è¿‘ä¹‰è¡¨è¿°ï¼ˆæ‰€æœ‰è¾“å…¥æœ¯è¯­éƒ½èƒ½åŒ¹é…ï¼‰
assertScoreAbove('ä¸€èˆ¬ç°åœ¨æ—¶çš„ç”¨æ³•', 'ä¸€èˆ¬ç°åœ¨æ—¶', 0.85,
    '#15 "ä¸€èˆ¬ç°åœ¨æ—¶çš„ç”¨æ³•" vs "ä¸€èˆ¬ç°åœ¨æ—¶" åº”>=85%');

assertScoreAbove('è¿‡å»å®Œæˆæ—¶æ€', 'è¿‡å»å®Œæˆæ—¶', 0.85,
    '#16 "è¿‡å»å®Œæˆæ—¶æ€" vs "è¿‡å»å®Œæˆæ—¶" åº”>=85% (ç›®æ ‡æ˜¯è¾“å…¥æ ¸å¿ƒå­ä¸²ï¼Œè·³è¿‡æƒ©ç½š)');

// æµ‹è¯•17-18: è¾“å…¥æœ‰2ä¸ªæœ¯è¯­ä¸”å…¨éƒ¨åŒ¹é…ï¼ˆè¦†ç›–ç‡100%ï¼‰
assertScoreAbove('å½¢å®¹è¯å’Œå‰¯è¯', 'å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§', 0.85,
    '#17 "å½¢å®¹è¯å’Œå‰¯è¯" vs "å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§" åº”>=85% (æ’é™¤è¿æ¥è¯"å’Œ"åæœ¯è¯­å…¨è¦†ç›–)');

assertScoreAbove('è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯', 'è¿‡å»åˆ†è¯ (v.-edä½œå½¢å®¹è¯)', 0.85,
    '#18 "è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯" vs "è¿‡å»åˆ†è¯ (v.-edä½œå½¢å®¹è¯)" åº”>=85%');

// æµ‹è¯•19-20: çŸ­æ–‡æœ¬åŒ¹é…
assertScoreAbove('åŠ¨åè¯', 'åŠ¨åè¯ (v.-ingä½œåè¯)', 0.80,
    '#19 "åŠ¨åè¯" vs "åŠ¨åè¯ (v.-ingä½œåè¯)" åº”>=80% (çŸ­æ–‡æœ¬åŸºç¡€åˆ†å—termRatioé™åˆ¶)');

assertScoreAbove('æƒ…æ€åŠ¨è¯ç”¨æ³•', 'æƒ…æ€åŠ¨è¯', 0.85,
    '#20 "æƒ…æ€åŠ¨è¯ç”¨æ³•" vs "æƒ…æ€åŠ¨è¯" åº”>=85%');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¬¬ä¸‰ç»„ (10ä¸ª): è¾¹ç•Œæƒ…å†µ â€” ç¡®ä¿æƒ©ç½šç²¾ç¡®
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
console.log('\nâ”€â”€ ç¬¬3ç»„: è¾¹ç•Œæƒ…å†µ â€” æƒ©ç½šç²¾åº¦éªŒè¯ (10ä¸ª) â”€â”€');

// æµ‹è¯•21-22: åŒç±»å‹ä¸åŒå…·ä½“é¡¹
assertScoreBelow('ä¸€èˆ¬è¿‡å»æ—¶å’Œç°åœ¨å®Œæˆæ—¶', 'ä¸€èˆ¬å°†æ¥æ—¶', 0.85,
    '#21 "ä¸€èˆ¬è¿‡å»æ—¶å’Œç°åœ¨å®Œæˆæ—¶" vs "ä¸€èˆ¬å°†æ¥æ—¶" åº”<85%');

assertScoreBelow('ä¸»è¯­ä»å¥å’Œå®¾è¯­ä»å¥', 'å®šè¯­ä»å¥', 0.85,
    '#22 "ä¸»è¯­ä»å¥å’Œå®¾è¯­ä»å¥" vs "å®šè¯­ä»å¥" åº”<85%');

// æµ‹è¯•23-24: é¢„æ£€æŸ¥å°±è¯¥é˜»æ­¢çš„ï¼ˆé›¶äº¤é›†ï¼‰
assertScoreBelow('ä»‹è¯æ­é…', 'æ—¶æ€å˜åŒ–', 0.85,
    '#23 "ä»‹è¯æ­é…" vs "æ—¶æ€å˜åŒ–" åº”<85% (é›¶äº¤é›†)');

assertScoreBelow('å† è¯ç”¨æ³•', 'è¢«åŠ¨è¯­æ€', 0.85,
    '#24 "å† è¯ç”¨æ³•" vs "è¢«åŠ¨è¯­æ€" åº”<85% (é›¶äº¤é›†)');

// æµ‹è¯•25-26: è¾“å…¥æ°å¥½2ä¸ªæœ¯è¯­ï¼Œ1ä¸ªåŒ¹é… (50%è¦†ç›–ç‡)
assertScoreBelow('å½¢å®¹è¯å’Œåè¯', 'å½¢å®¹è¯ç”¨æ³•', 0.85,
    '#25 "å½¢å®¹è¯å’Œåè¯" vs "å½¢å®¹è¯ç”¨æ³•" åº”<85% (æœ¯è¯­è¦†ç›–50%)');

assertScoreBelow('åŠ¨è¯å’Œä»‹è¯', 'åŠ¨è¯å½¢æ€', 0.85,
    '#26 "åŠ¨è¯å’Œä»‹è¯" vs "åŠ¨è¯å½¢æ€" åº”<85% (æœ¯è¯­è¦†ç›–ä¸è¶³)');

// æµ‹è¯•27-28: è¾“å…¥æœ‰3+æœ¯è¯­ï¼Œéƒ¨åˆ†åŒ¹é…
assertScoreBelow('å½¢å®¹è¯å‰¯è¯å’Œæ¯”è¾ƒçº§çš„åŒºåˆ«', 'å½¢å®¹è¯ç”¨æ³•', 0.85,
    '#27 "å½¢å®¹è¯å‰¯è¯å’Œæ¯”è¾ƒçº§çš„åŒºåˆ«" vs "å½¢å®¹è¯ç”¨æ³•" åº”<85% (æœ¯è¯­è¦†ç›–ä½)');

assertScoreBelow('åè¯åŠ¨è¯å’Œå½¢å®¹è¯çš„è¯æ€§è½¬æ¢', 'åè¯å•å¤æ•°', 0.85,
    '#28 "åè¯åŠ¨è¯å’Œå½¢å®¹è¯çš„è¯æ€§è½¬æ¢" vs "åè¯å•å¤æ•°" åº”<85%');

// æµ‹è¯•29-30: æ ‡å‡†åŒ–åç›¸åŒåº”ä¸å—å½±å“
assertScoreAbove('å½¢å®¹è¯/å‰¯è¯ æ¯”è¾ƒçº§', 'å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§', 0.95,
    '#29 "å½¢å®¹è¯/å‰¯è¯ æ¯”è¾ƒçº§" vs "å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§" åº”>=95% (æ ‡å‡†åŒ–ç›¸åŒ)');

assertScoreAbove('ä¸€èˆ¬ ç°åœ¨ æ—¶', 'ä¸€èˆ¬ç°åœ¨æ—¶', 0.95,
    '#30 "ä¸€èˆ¬ ç°åœ¨ æ—¶" vs "ä¸€èˆ¬ç°åœ¨æ—¶" åº”>=95% (æ ‡å‡†åŒ–ç›¸åŒ)');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¬¬å››ç»„ (10ä¸ª): Bug 27 éªŒè¯ + é›†æˆåœºæ™¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
console.log('\nâ”€â”€ ç¬¬4ç»„: Bug 27 + é›†æˆæµ‹è¯• (10ä¸ª) â”€â”€');

// æµ‹è¯•31-32: Bug 27 â€” extractCoreTerms ä¸åº”è¿”å›é‡å¤é¡¹
{
    const terms = matchingService.extractCoreTerms('è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯');
    const uniqueTerms = [...new Set(terms)];
    assert(terms.length === uniqueTerms.length,
        '#31 extractCoreTerms("è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯") ä¸åº”æœ‰é‡å¤é¡¹',
        `è¿”å›: [${terms.join(', ')}] å»é‡å: [${uniqueTerms.join(', ')}]`);
    
    const terms2 = matchingService.extractCoreTerms('åŠ¨è¯è¿‡å»å¼å’Œè¿‡å»åˆ†è¯çš„åŒºåˆ«');
    const uniqueTerms2 = [...new Set(terms2)];
    assert(terms2.length === uniqueTerms2.length,
        '#32 extractCoreTerms("åŠ¨è¯è¿‡å»å¼å’Œè¿‡å»åˆ†è¯çš„åŒºåˆ«") ä¸åº”æœ‰é‡å¤é¡¹',
        `è¿”å›: [${terms2.join(', ')}] å»é‡å: [${uniqueTerms2.join(', ')}]`);
}

// æµ‹è¯•33-34: calculateSimilarity èµ° isGrammarMatch åˆ†æ”¯
{
    const score1 = matchingService.calculateSimilarity('å½¢å®¹è¯ä½œè¡¨è¯­', 'è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯', { isGrammarMatch: true });
    assert(score1 < 0.85,
        '#33 calculateSimilarity isGrammarMatch "å½¢å®¹è¯ä½œè¡¨è¯­" vs "è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯" åº”<85%',
        `score=${(score1*100).toFixed(1)}%`);
    
    const score2 = matchingService.calculateSimilarity('æ¯”è¾ƒçº§çš„ç”¨æ³•', 'å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§', { isGrammarMatch: true });
    assert(score2 >= 0.85,
        '#34 calculateSimilarity isGrammarMatch "æ¯”è¾ƒçº§çš„ç”¨æ³•" vs "å½¢å®¹è¯/å‰¯è¯æ¯”è¾ƒçº§" åº”>=85%',
        `score=${(score2*100).toFixed(1)}%`);
}

// æµ‹è¯•35-36: å®Œæ•´åŒ¹é…æµç¨‹ï¼ˆmatchGrammar ç«¯åˆ°ç«¯ï¼‰
{
    let result35, result36;
    try {
        // matchGrammar æ˜¯å®Œæ•´4æ­¥æµç¨‹
        if (typeof matchingService.matchGrammar === 'function') {
            result35 = matchingService.matchGrammar('å½¢å®¹è¯å’Œå‰¯è¯çš„åŒºåˆ«');
            const wrongMatch35 = result35.matched && result35.matched_text === 'éè°“è¯­';
            assert(!wrongMatch35,
                '#35 matchGrammar("å½¢å®¹è¯å’Œå‰¯è¯çš„åŒºåˆ«") ä¸åº”åŒ¹é…åˆ°"éè°“è¯­"',
                `matched=${result35.matched} text="${result35.matched_text || 'N/A'}" score=${((result35.score||0)*100).toFixed(1)}%`);
            
            result36 = matchingService.matchGrammar('å½¢å®¹è¯ä½œè¡¨è¯­');
            const wrongMatch36 = result36.matched && result36.matched_text === 'éè°“è¯­';
            assert(!wrongMatch36,
                '#36 matchGrammar("å½¢å®¹è¯ä½œè¡¨è¯­") ä¸åº”åŒ¹é…åˆ°"éè°“è¯­"',
                `matched=${result36.matched} text="${result36.matched_text || 'N/A'}" score=${((result36.score||0)*100).toFixed(1)}%`);
        } else {
            // å°è¯•å…¶ä»–æ–¹æ³•å
            console.log('  âš ï¸ matchGrammar æ–¹æ³•ä¸å­˜åœ¨ï¼Œè·³è¿‡ #35 #36 ç«¯åˆ°ç«¯æµ‹è¯•');
            assert(true, '#35 [è·³è¿‡] matchGrammar ä¸å¯ç”¨');
            assert(true, '#36 [è·³è¿‡] matchGrammar ä¸å¯ç”¨');
        }
    } catch (e) {
        console.log(`  âš ï¸ ç«¯åˆ°ç«¯æµ‹è¯•å¼‚å¸¸: ${e.message}`);
        assert(true, '#35 [è·³è¿‡] ç«¯åˆ°ç«¯æµ‹è¯•å¼‚å¸¸');
        assert(true, '#36 [è·³è¿‡] ç«¯åˆ°ç«¯æµ‹è¯•å¼‚å¸¸');
    }
}

// æµ‹è¯•37-38: è½¬æ¢æ¨¡å¼ + è¦†ç›–ç‡åŒé‡ä¿æŠ¤
assertScoreBelow('å½¢å®¹è¯å˜å‰¯è¯', 'è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯', 0.70,
    '#37 "å½¢å®¹è¯å˜å‰¯è¯" vs "è¿‡å»åˆ†è¯ä½œå½¢å®¹è¯" åº”<70% (è½¬æ¢æ¨¡å¼+è¦†ç›–ç‡åŒé‡é˜»æ­¢)');

assertScoreBelow('åŠ¨è¯å˜åè¯', 'åŠ¨è¯å½¢æ€', 0.70,
    '#38 "åŠ¨è¯å˜åè¯" vs "åŠ¨è¯å½¢æ€" åº”<70% (è½¬æ¢æ¨¡å¼é˜»æ­¢)');

// æµ‹è¯•39-40: ä¸­è‹±æ··åˆæ–‡æœ¬
assertScoreBelow('spend doingçš„ç”¨æ³•', 'costçš„ç”¨æ³•', 0.85,
    '#39 "spend doingçš„ç”¨æ³•" vs "costçš„ç”¨æ³•" åº”<85%');

assertScoreAbove('spend doing', 'spend doing sth.', 0.80,
    '#40 "spend doing" vs "spend doing sth." åº”>=80%');

// ============ æµ‹è¯•ç»“æœæ±‡æ€» ============
console.log('\n' + '='.repeat(70));
console.log(`  æµ‹è¯•ç»“æœ: ${passed} é€šè¿‡ / ${failed} å¤±è´¥ / å…± ${passed + failed} ä¸ª`);
console.log('='.repeat(70));

if (failed > 0) {
    console.log('\nå¤±è´¥çš„æµ‹è¯•:');
    errors.forEach(e => console.log(e));
    console.log('');
    process.exit(1);
} else {
    console.log('\nğŸ‰ å…¨éƒ¨40ä¸ªæµ‹è¯•é€šè¿‡ï¼Bug 27 + Bug 28 ä¿®å¤éªŒè¯æˆåŠŸ\n');
    process.exit(0);
}