<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡æœ¬åˆ†å—ç®¡ç† - Sorryios AI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00d4ff;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 1000px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .card h2 {
      color: #00d4ff;
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2 .icon {
      font-size: 24px;
    }

    /* é…ç½®è¡¨å• */
    .config-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .form-group label {
      color: #aaa;
      font-size: 14px;
    }

    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group select {
      padding: 10px 15px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f23;
      color: #fff;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00d4ff;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .slider-group input[type="range"] {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: #333;
      appearance: none;
    }

    .slider-group input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00d4ff;
      cursor: pointer;
    }

    .slider-value {
      min-width: 80px;
      text-align: right;
      font-weight: bold;
      color: #00d4ff;
    }

    /* æŒ‰é’® */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }

    .btn-secondary {
      background: #333;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #444;
    }

    .btn-danger {
      background: #e74c3c;
      color: #fff;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* æ–‡æœ¬è¾“å…¥åŒº */
    .text-input {
      width: 100%;
      height: 300px;
      padding: 15px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f23;
      color: #fff;
      font-size: 14px;
      font-family: 'Consolas', monospace;
      resize: vertical;
    }

    .text-input:focus {
      outline: none;
      border-color: #00d4ff;
    }

    /* ç»“æœå±•ç¤º */
    .result-box {
      background: #0f0f23;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      padding: 10px;
      border-bottom: 1px solid #333;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item .chunk-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-item .chunk-index {
      background: #00d4ff;
      color: #000;
      padding: 2px 10px;
      border-radius: 4px;
      font-weight: bold;
    }

    .result-item .chunk-size {
      color: #888;
      font-size: 14px;
    }

    .result-item .chunk-preview {
      color: #aaa;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* ç»Ÿè®¡ä¿¡æ¯ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #0f0f23;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-item .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #00d4ff;
    }

    .stat-item .stat-label {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    /* æ–‡ä»¶åˆ—è¡¨ */
    .file-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #333;
    }

    .file-item:hover {
      background: #1a1a3e;
    }

    .file-item .file-name {
      flex: 1;
      font-family: monospace;
      color: #00d4ff;
      cursor: pointer;
    }

    .file-item .file-size {
      color: #888;
      font-size: 14px;
      margin: 0 15px;
    }

    .file-item .file-actions {
      display: flex;
      gap: 5px;
    }

    .file-item .file-actions button {
      padding: 5px 10px;
      font-size: 12px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #333;
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast æç¤º */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      background: #27ae60;
    }

    .toast.error {
      background: #e74c3c;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* å…¨å®½å¡ç‰‡ */
    .full-width {
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“„ æ–‡æœ¬åˆ†å—ç®¡ç†</h1>

    <div class="grid">
      <!-- é…ç½®å¡ç‰‡ -->
      <div class="card">
        <h2><span class="icon">âš™ï¸</span> åˆ†å—é…ç½®</h2>
        
        <div class="config-form">
          <div class="form-group">
            <label>åˆ†å—å¤§å°ï¼ˆå­—ç¬¦æ•°ï¼‰</label>
            <div class="slider-group">
              <input type="range" id="chunkSize" min="2000" max="12000" step="500" value="6000">
              <span class="slider-value" id="chunkSizeValue">6000</span>
            </div>
          </div>

          <div class="form-group">
            <label>æœ€å°åˆ†å—å¤§å°</label>
            <input type="number" id="minChunkSize" value="2000" min="500" max="5000">
          </div>

          <div class="form-group">
            <label>æœ€å¤§åˆ†å—å¤§å°</label>
            <input type="number" id="maxChunkSize" value="10000" min="5000" max="20000">
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="saveChunks" checked>
              ä¿å­˜åˆ†å—æ–‡ä»¶
            </label>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="btn btn-secondary" onclick="loadConfig()">ğŸ”„ é‡ç½®</button>
          </div>
        </div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="card">
        <h2><span class="icon">ğŸ“Š</span> åˆ†å—ç»Ÿè®¡</h2>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="statTotalLength">0</div>
            <div class="stat-label">æ€»å­—ç¬¦æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statChunks">0</div>
            <div class="stat-label">åˆ†å—æ•°é‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statAvgSize">0</div>
            <div class="stat-label">å¹³å‡å—å¤§å°</div>
          </div>
        </div>

        <div id="splitPointsInfo" style="color: #888; font-size: 14px;"></div>
      </div>

      <!-- æ–‡æœ¬è¾“å…¥ -->
      <div class="card full-width">
        <h2><span class="icon">ğŸ“</span> è¾“å…¥æ–‡æœ¬</h2>
        
        <textarea class="text-input" id="inputText" placeholder="åœ¨è¿™é‡Œç²˜è´´éœ€è¦åˆ†å—çš„æ–‡æœ¬..."></textarea>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="previewSplit()">ğŸ‘ï¸ é¢„è§ˆåˆ†å—</button>
          <button class="btn btn-primary" onclick="executeSplit()">âœ‚ï¸ æ‰§è¡Œåˆ†å—</button>
          <button class="btn btn-secondary" onclick="clearInput()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <div>å¤„ç†ä¸­...</div>
        </div>
      </div>

      <!-- åˆ†å—ç»“æœ -->
      <div class="card">
        <h2><span class="icon">ğŸ“¦</span> åˆ†å—ç»“æœ</h2>
        
        <div class="result-box" id="resultBox">
          <div style="color: #888; text-align: center; padding: 40px;">
            ç‚¹å‡»"é¢„è§ˆåˆ†å—"æˆ–"æ‰§è¡Œåˆ†å—"æŸ¥çœ‹ç»“æœ
          </div>
        </div>
      </div>

      <!-- å·²ä¿å­˜æ–‡ä»¶ -->
      <div class="card">
        <h2><span class="icon">ğŸ“</span> å·²ä¿å­˜çš„åˆ†å—æ–‡ä»¶</h2>
        
        <div class="btn-group" style="margin-bottom: 15px;">
          <button class="btn btn-secondary" onclick="loadFiles()">ğŸ”„ åˆ·æ–°</button>
          <button class="btn btn-danger" onclick="clearAllFiles()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        </div>

        <div class="file-list" id="fileList">
          <div style="color: #888; text-align: center; padding: 20px;">
            åŠ è½½ä¸­...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API åŸºç¡€è·¯å¾„
    const API_BASE = '/api/chunk';

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      loadFiles();
      
      // æ»‘å—å€¼å®æ—¶æ›´æ–°
      const slider = document.getElementById('chunkSize');
      const valueDisplay = document.getElementById('chunkSizeValue');
      slider.addEventListener('input', () => {
        valueDisplay.textContent = slider.value;
      });
    });

    // Toast æç¤º
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // æ˜¾ç¤º/éšè—åŠ è½½
    function setLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const res = await fetch(`${API_BASE}/config`);
        const data = await res.json();
        
        if (data.success) {
          const config = data.data.chunk_settings;
          document.getElementById('chunkSize').value = config.default_chunk_size;
          document.getElementById('chunkSizeValue').textContent = config.default_chunk_size;
          document.getElementById('minChunkSize').value = config.min_chunk_size;
          document.getElementById('maxChunkSize').value = config.max_chunk_size;
          document.getElementById('saveChunks').checked = data.data.output_settings.save_chunks;
        }
      } catch (err) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', err);
      }
    }

    // ä¿å­˜é…ç½®
    async function saveConfig() {
      try {
        const config = {
          chunk_size: parseInt(document.getElementById('chunkSize').value),
          min_chunk_size: parseInt(document.getElementById('minChunkSize').value),
          max_chunk_size: parseInt(document.getElementById('maxChunkSize').value),
          save_chunks: document.getElementById('saveChunks').checked,
        };

        const res = await fetch(`${API_BASE}/config`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config),
        });

        const data = await res.json();
        
        if (data.success) {
          showToast('é…ç½®å·²ä¿å­˜');
        } else {
          showToast(data.error, 'error');
        }
      } catch (err) {
        showToast('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
      }
    }

    // é¢„è§ˆåˆ†å—
    async function previewSplit() {
      const text = document.getElementById('inputText').value;
      
      if (!text.trim()) {
        showToast('è¯·è¾“å…¥æ–‡æœ¬', 'error');
        return;
      }

      setLoading(true);

      try {
        const res = await fetch(`${API_BASE}/preview`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text,
            chunk_size: parseInt(document.getElementById('chunkSize').value),
          }),
        });

        const data = await res.json();
        
        if (data.success) {
          updateStats(data.data);
          displayPreview(data.data);
          showToast('é¢„è§ˆå®Œæˆ');
        } else {
          showToast(data.error, 'error');
        }
      } catch (err) {
        showToast('é¢„è§ˆå¤±è´¥: ' + err.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    // æ‰§è¡Œåˆ†å—
    async function executeSplit() {
      const text = document.getElementById('inputText').value;
      
      if (!text.trim()) {
        showToast('è¯·è¾“å…¥æ–‡æœ¬', 'error');
        return;
      }

      setLoading(true);

      try {
        const res = await fetch(`${API_BASE}/split`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text,
            filename: `text_${Date.now()}`,
            chunk_size: parseInt(document.getElementById('chunkSize').value),
            save_chunks: document.getElementById('saveChunks').checked,
          }),
        });

        const data = await res.json();
        
        if (data.success) {
          displayChunks(data.data.chunks);
          updateStats({
            totalLength: text.length,
            estimatedChunks: data.data.totalChunks,
            avgChunkSize: data.data.stats.avgChunkSize,
          });
          loadFiles(); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
          showToast(`åˆ†å—å®Œæˆï¼Œå…± ${data.data.totalChunks} å—`);
        } else {
          showToast(data.error, 'error');
        }
      } catch (err) {
        showToast('åˆ†å—å¤±è´¥: ' + err.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(data) {
      document.getElementById('statTotalLength').textContent = data.totalLength.toLocaleString();
      document.getElementById('statChunks').textContent = data.estimatedChunks;
      document.getElementById('statAvgSize').textContent = data.avgChunkSize.toLocaleString();
      
      if (data.splitPoints) {
        const patterns = data.splitPoints.map(p => p.pattern).join(' â†’ ');
        document.getElementById('splitPointsInfo').textContent = `åˆ‡åˆ†æ¨¡å¼: ${patterns}`;
      }
    }

    // æ˜¾ç¤ºé¢„è§ˆ
    function displayPreview(data) {
      const resultBox = document.getElementById('resultBox');
      
      let html = data.splitPoints.map((point, index) => `
        <div class="result-item">
          <div class="chunk-header">
            <span class="chunk-index">å— ${index + 1}</span>
            <span class="chunk-size">${point.chunkSize || '?'} å­—ç¬¦ | æ¨¡å¼: ${point.pattern}</span>
          </div>
          <div class="chunk-preview">${escapeHtml(point.preview || '')}</div>
        </div>
      `).join('');

      resultBox.innerHTML = html;
    }

    // æ˜¾ç¤ºåˆ†å—ç»“æœ
    function displayChunks(chunks) {
      const resultBox = document.getElementById('resultBox');
      
      let html = chunks.map(chunk => `
        <div class="result-item">
          <div class="chunk-header">
            <span class="chunk-index">å— ${chunk.index + 1}</span>
            <span class="chunk-size">${chunk.charCount} å­—ç¬¦</span>
          </div>
          <div class="chunk-preview">${escapeHtml(chunk.preview)}</div>
        </div>
      `).join('');

      resultBox.innerHTML = html;
    }

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    async function loadFiles() {
      try {
        const res = await fetch(`${API_BASE}/files`);
        const data = await res.json();
        
        if (data.success) {
          displayFiles(data.data.files);
        }
      } catch (err) {
        console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', err);
      }
    }

    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
    function displayFiles(files) {
      const fileList = document.getElementById('fileList');
      
      if (files.length === 0) {
        fileList.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">æš‚æ— ä¿å­˜çš„æ–‡ä»¶</div>';
        return;
      }

      let html = files.map(file => `
        <div class="file-item">
          <span class="file-name" onclick="viewFile('${file.filename}')">${file.filename}</span>
          <span class="file-size">${formatSize(file.size)}</span>
          <div class="file-actions">
            <button class="btn btn-secondary" onclick="downloadFile('${file.filename}')">â¬‡ï¸</button>
            <button class="btn btn-danger" onclick="deleteFile('${file.filename}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');

      fileList.innerHTML = html;
    }

    // æŸ¥çœ‹æ–‡ä»¶
    async function viewFile(filename) {
      try {
        const res = await fetch(`${API_BASE}/files/${filename}`);
        const data = await res.json();
        
        if (data.success) {
          if (data.data.isJson) {
            alert(JSON.stringify(data.data.content, null, 2));
          } else {
            document.getElementById('inputText').value = data.data.content;
            showToast('å·²åŠ è½½åˆ°è¾“å…¥æ¡†');
          }
        }
      } catch (err) {
        showToast('åŠ è½½æ–‡ä»¶å¤±è´¥', 'error');
      }
    }

    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(filename) {
      window.open(`${API_BASE}/files/${filename}?download=1`, '_blank');
    }

    // åˆ é™¤æ–‡ä»¶
    async function deleteFile(filename) {
      if (!confirm(`ç¡®å®šåˆ é™¤ ${filename}ï¼Ÿ`)) return;

      try {
        const res = await fetch(`${API_BASE}/files/${filename}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          showToast('æ–‡ä»¶å·²åˆ é™¤');
          loadFiles();
        } else {
          showToast(data.error, 'error');
        }
      } catch (err) {
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶
    async function clearAllFiles() {
      if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åˆ†å—æ–‡ä»¶ï¼Ÿ')) return;

      try {
        const res = await fetch(`${API_BASE}/files`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message);
          loadFiles();
        }
      } catch (err) {
        showToast('æ¸…ç©ºå¤±è´¥', 'error');
      }
    }

    // æ¸…ç©ºè¾“å…¥
    function clearInput() {
      document.getElementById('inputText').value = '';
      document.getElementById('resultBox').innerHTML = '<div style="color: #888; text-align: center; padding: 40px;">ç‚¹å‡»"é¢„è§ˆåˆ†å—"æˆ–"æ‰§è¡Œåˆ†å—"æŸ¥çœ‹ç»“æœ</div>';
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1024 / 1024).toFixed(1) + ' MB';
    }
  </script>
</body>
</html>
