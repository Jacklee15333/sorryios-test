<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­æ³•åº“ç®¡ç† - Sorryios AI</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.self !== window.top) {
                // å¼ºåˆ¶é‡ç½® - å»æ‰æ‰€æœ‰è¾¹è·
                document.documentElement.style.cssText = 'margin: 0 !important; padding: 0 !important; width: 100% !important;';
                document.body.classList.add('in-iframe');
                document.body.style.cssText = 'padding: 0 !important; margin: 0 !important; width: 100% !important; min-width: 0 !important;';
                
                const container = document.querySelector('.container');
                if (container) {
                    container.style.cssText = 'max-width: none !important; width: 100% !important; margin: 0 !important; padding: 10px !important; min-width: 0 !important;';
                }
                
                const backLink = document.querySelector('.back-link');
                if (backLink) backLink.style.display = 'none';
                
                console.log('[è¯­æ³•åº“] iframeæ¨¡å¼å·²æ¿€æ´»');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* iframeå†…åµŒæ—¶çš„æ ·å¼ - å®Œå…¨é€‚é… */
        body.in-iframe {
            padding: 12px !important;
            margin: 0 !important;
            overflow-x: hidden;
        }
        body.in-iframe .back-link {
            display: none !important;
        }
        body.in-iframe .container {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        body.in-iframe .header {
            padding: 16px !important;
            margin-bottom: 12px !important;
        }
        body.in-iframe .header h1 {
            font-size: 20px !important;
        }
        body.in-iframe .toolbar {
            padding: 12px !important;
            margin-bottom: 12px !important;
        }
        body.in-iframe .main-area {
            gap: 12px !important;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #666;
        }
        
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .stat-item strong {
            font-size: 20px;
            margin-right: 4px;
        }
        
        .toolbar {
            background: white;
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            display: flex;
            gap: 8px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .filter-select {
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .sidebar h3 {
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .category-list {
            list-style: none;
        }
        
        .category-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-item:hover {
            background: #f3f4f6;
        }
        
        .category-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .category-count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .grammar-list {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .grammar-item {
            padding: 20px 24px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .grammar-item:hover {
            background: #f9fafb;
        }
        
        .grammar-item:last-child {
            border-bottom: none;
        }
        
        .grammar-item.disabled {
            opacity: 0.5;
        }
        
        .grammar-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grammar-title .badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            background: #e0e7ff;
            color: #4338ca;
        }
        
        .grammar-definition {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .grammar-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .keyword-tag {
            background: #f3f4f6;
            color: #4b5563;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .grammar-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .grammar-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            margin: 20px 0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: #333;
            font-size: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-group .hint {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .array-input {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .array-item {
            display: flex;
            gap: 8px;
        }
        
        .array-item input {
            flex: 1;
        }
        
        .array-item .btn {
            padding: 8px 12px;
        }
        
        .mistake-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .mistake-item input {
            margin-bottom: 8px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            background: #10b981;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #666;
            text-decoration: none;
            margin-bottom: 16px;
            transition: color 0.3s;
        }
        
        .back-link:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin" class="back-link">â† è¿”å›ç®¡ç†åå°</a>
        
        <div class="header">
            <h1>ğŸ“š è¯­æ³•åº“ç®¡ç†</h1>
            <p>ç®¡ç†åˆä¸­è‹±è¯­è¯­æ³•çŸ¥è¯†åº“ï¼Œæ”¯æŒæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤è¯­æ³•ç‚¹</p>
            <div class="stats-bar" id="statsBar">
                <div class="stat-item"><strong id="statTotal">0</strong> æ€»æ•°</div>
                <div class="stat-item"><strong id="statEnabled">0</strong> å·²å¯ç”¨</div>
                <div class="stat-item"><strong id="statDisabled">0</strong> å·²ç¦ç”¨</div>
            </div>
        </div>
        
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢è¯­æ³•ç‚¹...">
                <button class="btn btn-primary" onclick="searchGrammar()">æœç´¢</button>
            </div>
            <select class="filter-select" id="categoryFilter" onchange="filterByCategory()">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
            </select>
            <button class="btn btn-success" onclick="openAddModal()">+ æ·»åŠ è¯­æ³•</button>
            <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡º JSON</button>
            <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">å¯¼å…¥ JSON</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h3>åˆ†ç±»</h3>
                <ul class="category-list" id="categoryList">
                    <li class="category-item active" data-category="" onclick="selectCategory(this)">
                        <span>å…¨éƒ¨</span>
                        <span class="category-count" id="countAll">0</span>
                    </li>
                </ul>
            </div>
            
            <div class="grammar-list" id="grammarList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ è¯­æ³•ç‚¹</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="grammarId">
                
                <div class="form-group">
                    <label>æ ‡é¢˜ *</label>
                    <input type="text" id="grammarTitle" placeholder="å¦‚ï¼šä¸€èˆ¬ç°åœ¨æ—¶">
                </div>
                
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="grammarCategory">
                        <option value="æ—¶æ€">æ—¶æ€</option>
                        <option value="è¯­æ€">è¯­æ€</option>
                        <option value="éè°“è¯­åŠ¨è¯">éè°“è¯­åŠ¨è¯</option>
                        <option value="ä»å¥">ä»å¥</option>
                        <option value="å¥å¼">å¥å¼</option>
                        <option value="æ¯”è¾ƒç­‰çº§">æ¯”è¾ƒç­‰çº§</option>
                        <option value="è¯æ³•">è¯æ³•</option>
                        <option value="è¯æ±‡è¾¨æ">è¯æ±‡è¾¨æ</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å…³é”®è¯ * (ç”¨äºè‡ªåŠ¨æ£€æµ‹)</label>
                    <div class="array-input" id="keywordsInput">
                        <div class="array-item">
                            <input type="text" placeholder="å…³é”®è¯">
                            <button class="btn btn-danger" onclick="removeArrayItem(this)">åˆ é™¤</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addArrayItem('keywordsInput')" style="margin-top:8px">+ æ·»åŠ å…³é”®è¯</button>
                    <p class="hint">è¾“å…¥èƒ½å¤Ÿè¯†åˆ«è¯¥è¯­æ³•ç‚¹çš„å…³é”®è¯ï¼Œå¦‚"ä¸€èˆ¬ç°åœ¨æ—¶"ã€"do/does"</p>
                </div>
                
                <div class="form-group">
                    <label>å®šä¹‰ *</label>
                    <textarea id="grammarDefinition" placeholder="è¯¦ç»†è§£é‡Šè¿™ä¸ªè¯­æ³•ç‚¹æ˜¯ä»€ä¹ˆ"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ç»“æ„</label>
                    <input type="text" id="grammarStructure" placeholder="å¦‚ï¼šä¸»è¯­ + åŠ¨è¯åŸå½¢">
                </div>
                
                <div class="form-group">
                    <label>ç”¨æ³•</label>
                    <div class="array-input" id="usageInput">
                        <div class="array-item">
                            <input type="text" placeholder="ç”¨æ³•è¯´æ˜">
                            <button class="btn btn-danger" onclick="removeArrayItem(this)">åˆ é™¤</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addArrayItem('usageInput')" style="margin-top:8px">+ æ·»åŠ ç”¨æ³•</button>
                </div>
                
                <div class="form-group">
                    <label>æ˜“é”™ç‚¹</label>
                    <div id="mistakesInput">
                        <div class="mistake-item">
                            <input type="text" class="mistake-wrong" placeholder="é”™è¯¯å†™æ³•">
                            <input type="text" class="mistake-correct" placeholder="æ­£ç¡®å†™æ³•">
                            <input type="text" class="mistake-explanation" placeholder="è§£é‡Š">
                            <button class="btn btn-danger" onclick="removeMistakeItem(this)" style="margin-top:8px">åˆ é™¤</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addMistakeItem()" style="margin-top:8px">+ æ·»åŠ æ˜“é”™ç‚¹</button>
                </div>
                
                <div class="form-group">
                    <label>ä¾‹å¥</label>
                    <div class="array-input" id="examplesInput">
                        <div class="array-item">
                            <input type="text" placeholder="ä¾‹å¥">
                            <button class="btn btn-danger" onclick="removeArrayItem(this)">åˆ é™¤</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addArrayItem('examplesInput')" style="margin-top:8px">+ æ·»åŠ ä¾‹å¥</button>
                </div>
                
                <div class="form-group">
                    <label>éš¾åº¦</label>
                    <select id="grammarDifficulty">
                        <option value="1">ç®€å•</option>
                        <option value="2" selected>ä¸­ç­‰</option>
                        <option value="3">å›°éš¾</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveGrammar()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewTitle">è¯­æ³•è¯¦æƒ…</h2>
                <button class="modal-close" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body" id="viewContent">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeViewModal()">å…³é—­</button>
                <button class="btn btn-primary" id="viewEditBtn">ç¼–è¾‘</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        const API_BASE = '/api/grammar';
        let allGrammar = [];
        let currentCategory = '';
        let currentViewId = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadCategories();
            loadGrammar();
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchGrammar();
            });
        });
        
        // åŠ è½½ç»Ÿè®¡
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('statTotal').textContent = data.data.total;
                    document.getElementById('statEnabled').textContent = data.data.enabled;
                    document.getElementById('statDisabled').textContent = data.data.disabled;
                }
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
            }
        }
        
        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/categories`);
                const data = await res.json();
                if (data.success) {
                    const list = document.getElementById('categoryList');
                    // ä¿ç•™"å…¨éƒ¨"é€‰é¡¹
                    list.innerHTML = `
                        <li class="category-item active" data-category="" onclick="selectCategory(this)">
                            <span>å…¨éƒ¨</span>
                            <span class="category-count" id="countAll">0</span>
                        </li>
                    `;
                    
                    data.data.forEach(cat => {
                        list.innerHTML += `
                            <li class="category-item" data-category="${cat}" onclick="selectCategory(this)">
                                <span>${cat}</span>
                                <span class="category-count">0</span>
                            </li>
                        `;
                    });
                    
                    // æ›´æ–°ç­›é€‰ä¸‹æ‹‰æ¡†
                    const select = document.getElementById('categoryFilter');
                    select.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>';
                    data.data.forEach(cat => {
                        select.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                }
            } catch (e) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', e);
            }
        }
        
        // åŠ è½½è¯­æ³•åˆ—è¡¨
        async function loadGrammar() {
            try {
                const res = await fetch(`${API_BASE}?all=true`);
                const data = await res.json();
                if (data.success) {
                    allGrammar = data.data;
                    document.getElementById('countAll').textContent = allGrammar.length;
                    updateCategoryCounts();
                    renderGrammarList(allGrammar);
                }
            } catch (e) {
                console.error('åŠ è½½è¯­æ³•å¤±è´¥:', e);
                document.getElementById('grammarList').innerHTML = `
                    <div class="empty-state">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°åˆ†ç±»è®¡æ•°
        function updateCategoryCounts() {
            const counts = {};
            allGrammar.forEach(g => {
                counts[g.category] = (counts[g.category] || 0) + 1;
            });
            
            document.querySelectorAll('.category-item').forEach(item => {
                const cat = item.dataset.category;
                if (cat) {
                    const countEl = item.querySelector('.category-count');
                    countEl.textContent = counts[cat] || 0;
                }
            });
        }
        
        // æ¸²æŸ“è¯­æ³•åˆ—è¡¨
        function renderGrammarList(grammar) {
            const container = document.getElementById('grammarList');
            
            if (grammar.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— è¯­æ³•ç‚¹</h3>
                        <p>ç‚¹å‡»"æ·»åŠ è¯­æ³•"æŒ‰é’®åˆ›å»ºæ–°çš„è¯­æ³•ç‚¹</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = grammar.map(g => `
                <div class="grammar-item ${g.enabled ? '' : 'disabled'}" onclick="viewGrammar(${g.id})">
                    <div class="grammar-title">
                        ${g.title}
                        <span class="badge">${g.category}</span>
                        ${!g.enabled ? '<span class="badge" style="background:#fee2e2;color:#dc2626">å·²ç¦ç”¨</span>' : ''}
                    </div>
                    <div class="grammar-definition">${g.definition}</div>
                    <div class="grammar-keywords">
                        ${g.keywords.slice(0, 5).map(k => `<span class="keyword-tag">${k}</span>`).join('')}
                        ${g.keywords.length > 5 ? `<span class="keyword-tag">+${g.keywords.length - 5}</span>` : ''}
                    </div>
                    <div class="grammar-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-primary" onclick="editGrammar(${g.id})">ç¼–è¾‘</button>
                        <button class="btn ${g.enabled ? 'btn-warning' : 'btn-success'}" onclick="toggleGrammar(${g.id})">
                            ${g.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteGrammar(${g.id}, '${g.title}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // é€‰æ‹©åˆ†ç±»
        function selectCategory(el) {
            document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');
            currentCategory = el.dataset.category;
            filterByCategory();
        }
        
        // æŒ‰åˆ†ç±»ç­›é€‰
        function filterByCategory() {
            const category = currentCategory || document.getElementById('categoryFilter').value;
            const filtered = category 
                ? allGrammar.filter(g => g.category === category)
                : allGrammar;
            renderGrammarList(filtered);
        }
        
        // æœç´¢
        async function searchGrammar() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                renderGrammarList(allGrammar);
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/search?keyword=${encodeURIComponent(keyword)}`);
                const data = await res.json();
                if (data.success) {
                    renderGrammarList(data.data);
                }
            } catch (e) {
                console.error('æœç´¢å¤±è´¥:', e);
            }
        }
        
        // æŸ¥çœ‹è¯¦æƒ…
        function viewGrammar(id) {
            const grammar = allGrammar.find(g => g.id === id);
            if (!grammar) return;
            
            currentViewId = id;
            document.getElementById('viewTitle').textContent = grammar.title;
            document.getElementById('viewEditBtn').onclick = () => { closeViewModal(); editGrammar(id); };
            
            document.getElementById('viewContent').innerHTML = `
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <p>${grammar.category}</p>
                </div>
                <div class="form-group">
                    <label>å…³é”®è¯</label>
                    <div class="grammar-keywords">
                        ${grammar.keywords.map(k => `<span class="keyword-tag">${k}</span>`).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label>å®šä¹‰</label>
                    <p>${grammar.definition}</p>
                </div>
                <div class="form-group">
                    <label>ç»“æ„</label>
                    <p>${grammar.structure || 'æ— '}</p>
                </div>
                <div class="form-group">
                    <label>ç”¨æ³•</label>
                    <ul style="margin-left:20px">
                        ${grammar.usage.map(u => `<li>${u}</li>`).join('') || '<li>æ— </li>'}
                    </ul>
                </div>
                <div class="form-group">
                    <label>æ˜“é”™ç‚¹</label>
                    ${grammar.mistakes.length > 0 ? grammar.mistakes.map(m => `
                        <div style="background:#fef2f2;padding:12px;border-radius:8px;margin-bottom:8px">
                            <div style="color:#dc2626">âŒ ${m.wrong}</div>
                            <div style="color:#16a34a">âœ… ${m.correct}</div>
                            <div style="color:#666;font-size:12px;margin-top:4px">${m.explanation}</div>
                        </div>
                    `).join('') : '<p>æ— </p>'}
                </div>
                <div class="form-group">
                    <label>ä¾‹å¥</label>
                    <ul style="margin-left:20px">
                        ${grammar.examples.map(e => `<li>${e}</li>`).join('') || '<li>æ— </li>'}
                    </ul>
                </div>
            `;
            
            document.getElementById('viewModal').classList.add('active');
        }
        
        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }
        
        // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ è¯­æ³•ç‚¹';
            document.getElementById('grammarId').value = '';
            clearForm();
            document.getElementById('editModal').classList.add('active');
        }
        
        // ç¼–è¾‘è¯­æ³•
        function editGrammar(id) {
            const grammar = allGrammar.find(g => g.id === id);
            if (!grammar) return;
            
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è¯­æ³•ç‚¹';
            document.getElementById('grammarId').value = id;
            document.getElementById('grammarTitle').value = grammar.title;
            document.getElementById('grammarCategory').value = grammar.category;
            document.getElementById('grammarDefinition').value = grammar.definition;
            document.getElementById('grammarStructure').value = grammar.structure;
            document.getElementById('grammarDifficulty').value = grammar.difficulty;
            
            // å¡«å……å…³é”®è¯
            fillArrayInput('keywordsInput', grammar.keywords);
            // å¡«å……ç”¨æ³•
            fillArrayInput('usageInput', grammar.usage);
            // å¡«å……ä¾‹å¥
            fillArrayInput('examplesInput', grammar.examples);
            // å¡«å……æ˜“é”™ç‚¹
            fillMistakes(grammar.mistakes);
            
            document.getElementById('editModal').classList.add('active');
        }
        
        // å¡«å……æ•°ç»„è¾“å…¥
        function fillArrayInput(containerId, values) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (values.length === 0) values = [''];
            values.forEach(v => {
                container.innerHTML += `
                    <div class="array-item">
                        <input type="text" value="${v}">
                        <button class="btn btn-danger" onclick="removeArrayItem(this)">åˆ é™¤</button>
                    </div>
                `;
            });
        }
        
        // å¡«å……æ˜“é”™ç‚¹
        function fillMistakes(mistakes) {
            const container = document.getElementById('mistakesInput');
            container.innerHTML = '';
            if (mistakes.length === 0) {
                addMistakeItem();
                return;
            }
            mistakes.forEach(m => {
                container.innerHTML += `
                    <div class="mistake-item">
                        <input type="text" class="mistake-wrong" value="${m.wrong}" placeholder="é”™è¯¯å†™æ³•">
                        <input type="text" class="mistake-correct" value="${m.correct}" placeholder="æ­£ç¡®å†™æ³•">
                        <input type="text" class="mistake-explanation" value="${m.explanation}" placeholder="è§£é‡Š">
                        <button class="btn btn-danger" onclick="removeMistakeItem(this)" style="margin-top:8px">åˆ é™¤</button>
                    </div>
                `;
            });
        }
        
        // æ·»åŠ æ•°ç»„é¡¹
        function addArrayItem(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'array-item';
            div.innerHTML = `
                <input type="text" placeholder="${containerId === 'keywordsInput' ? 'å…³é”®è¯' : containerId === 'usageInput' ? 'ç”¨æ³•è¯´æ˜' : 'ä¾‹å¥'}">
                <button class="btn btn-danger" onclick="removeArrayItem(this)">åˆ é™¤</button>
            `;
            container.appendChild(div);
        }
        
        // åˆ é™¤æ•°ç»„é¡¹
        function removeArrayItem(btn) {
            btn.parentElement.remove();
        }
        
        // æ·»åŠ æ˜“é”™ç‚¹é¡¹
        function addMistakeItem() {
            const container = document.getElementById('mistakesInput');
            const div = document.createElement('div');
            div.className = 'mistake-item';
            div.innerHTML = `
                <input type="text" class="mistake-wrong" placeholder="é”™è¯¯å†™æ³•">
                <input type="text" class="mistake-correct" placeholder="æ­£ç¡®å†™æ³•">
                <input type="text" class="mistake-explanation" placeholder="è§£é‡Š">
                <button class="btn btn-danger" onclick="removeMistakeItem(this)" style="margin-top:8px">åˆ é™¤</button>
            `;
            container.appendChild(div);
        }
        
        // åˆ é™¤æ˜“é”™ç‚¹é¡¹
        function removeMistakeItem(btn) {
            btn.parentElement.remove();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('grammarTitle').value = '';
            document.getElementById('grammarCategory').value = 'æ—¶æ€';
            document.getElementById('grammarDefinition').value = '';
            document.getElementById('grammarStructure').value = '';
            document.getElementById('grammarDifficulty').value = '2';
            fillArrayInput('keywordsInput', ['']);
            fillArrayInput('usageInput', ['']);
            fillArrayInput('examplesInput', ['']);
            document.getElementById('mistakesInput').innerHTML = '';
            addMistakeItem();
        }
        
        // è·å–æ•°ç»„è¾“å…¥å€¼
        function getArrayValues(containerId) {
            const inputs = document.querySelectorAll(`#${containerId} input`);
            return Array.from(inputs).map(i => i.value.trim()).filter(v => v);
        }
        
        // è·å–æ˜“é”™ç‚¹å€¼
        function getMistakesValues() {
            const items = document.querySelectorAll('#mistakesInput .mistake-item');
            return Array.from(items).map(item => ({
                wrong: item.querySelector('.mistake-wrong').value.trim(),
                correct: item.querySelector('.mistake-correct').value.trim(),
                explanation: item.querySelector('.mistake-explanation').value.trim()
            })).filter(m => m.wrong && m.correct);
        }
        
        // ä¿å­˜è¯­æ³•
        async function saveGrammar() {
            const id = document.getElementById('grammarId').value;
            const grammar = {
                title: document.getElementById('grammarTitle').value.trim(),
                category: document.getElementById('grammarCategory').value,
                keywords: getArrayValues('keywordsInput'),
                definition: document.getElementById('grammarDefinition').value.trim(),
                structure: document.getElementById('grammarStructure').value.trim(),
                usage: getArrayValues('usageInput'),
                mistakes: getMistakesValues(),
                examples: getArrayValues('examplesInput'),
                difficulty: parseInt(document.getElementById('grammarDifficulty').value)
            };
            
            // éªŒè¯
            if (!grammar.title) {
                showToast('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                return;
            }
            if (!grammar.definition) {
                showToast('è¯·è¾“å…¥å®šä¹‰', 'error');
                return;
            }
            if (grammar.keywords.length === 0) {
                showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå…³é”®è¯', 'error');
                return;
            }
            
            try {
                const url = id ? `${API_BASE}/${id}` : API_BASE;
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(grammar)
                });
                
                const data = await res.json();
                if (data.success) {
                    showToast(id ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                    closeModal();
                    loadStats();
                    loadCategories();
                    loadGrammar();
                } else {
                    showToast(data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (e) {
                console.error('ä¿å­˜å¤±è´¥:', e);
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }
        
        // åˆ‡æ¢å¯ç”¨çŠ¶æ€
        async function toggleGrammar(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}/toggle`, { method: 'PATCH' });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadStats();
                    loadGrammar();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // åˆ é™¤è¯­æ³•
        async function deleteGrammar(id, title) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    loadStats();
                    loadCategories();
                    loadGrammar();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                const res = await fetch(`${API_BASE}/export`);
                const data = await res.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grammar_database.json';
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (e) {
                showToast('å¯¼å‡ºå¤±è´¥', 'error');
            }
        }
        
        // å¯¼å…¥æ•°æ®
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                const res = await fetch(`${API_BASE}/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data })
                });
                
                const result = await res.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    loadStats();
                    loadCategories();
                    loadGrammar();
                } else {
                    showToast(result.error, 'error');
                }
            } catch (e) {
                console.error('å¯¼å…¥å¤±è´¥:', e);
                showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
            }
            
            event.target.value = '';
        }
        
        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
