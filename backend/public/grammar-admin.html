<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­æ³•åº“ç®¡ç† - Sorryios AI</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
                const backLink = document.querySelector('.back-link');
                if (backLink) backLink.style.display = 'none';
            }
        });
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f7f7f8;
            min-height: 100vh; 
            padding: 24px;
            color: #1a1a1a;
        }
        body.in-iframe { padding: 16px; }
        body.in-iframe .back-link { display: none; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .back-link { display: inline-block; color: #666; text-decoration: none; margin-bottom: 16px; font-size: 14px; }
        .back-link:hover { color: #1a1a1a; }
        
        .header { 
            background: white; border-radius: 12px; padding: 24px; 
            margin-bottom: 16px; border: 1px solid #e5e5e5;
        }
        .header h1 { font-size: 20px; font-weight: 600; margin-bottom: 6px; }
        .header p { color: #666; font-size: 14px; margin-bottom: 16px; }
        .stats-bar { display: flex; gap: 12px; flex-wrap: wrap; }
        .stat-item { 
            background: #f7f7f8; color: #1a1a1a; padding: 8px 16px; 
            border-radius: 8px; font-size: 14px; border: 1px solid #e5e5e5;
        }
        .stat-item strong { font-size: 18px; font-weight: 600; margin-right: 4px; color: #7c3aed; }
        
        /* Tab åˆ‡æ¢ - æ”¯æŒæ»šåŠ¨ */
        .tabs { 
            background: white; border-radius: 12px; padding: 6px; 
            margin-bottom: 16px; display: flex; gap: 4px;
            border: 1px solid #e5e5e5;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tabs::-webkit-scrollbar { height: 4px; }
        .tabs::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }
        
        .tab-btn { 
            padding: 10px 16px; border: none; border-radius: 8px; 
            font-size: 14px; font-weight: 500; cursor: pointer; 
            transition: all 0.15s; background: transparent; color: #666;
            white-space: nowrap; flex-shrink: 0;
        }
        .tab-btn:hover { background: #f7f7f8; color: #1a1a1a; }
        .tab-btn.active { background: #7c3aed; color: white; }
        
        .toolbar { 
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; 
            display: flex; gap: 12px; align-items: center; flex-wrap: wrap; border: 1px solid #e5e5e5;
        }
        .search-box { display: flex; gap: 8px; flex: 1; min-width: 200px; }
        .search-box input { 
            flex: 1; padding: 8px 12px; border: 1px solid #e5e5e5; 
            border-radius: 8px; font-size: 14px; outline: none;
        }
        .search-box input:focus { border-color: #7c3aed; }
        
        .btn { 
            padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; 
            font-weight: 500; cursor: pointer; transition: all 0.15s; white-space: nowrap;
            background: white; color: #374151;
        }
        .btn:hover { background: #f9fafb; border-color: #9ca3af; }
        .btn-primary { background: white; color: #7c3aed; border: 1px solid #c4b5fd; }
        .btn-primary:hover { background: #f5f3ff; border-color: #a78bfa; }
        .btn-secondary { background: white; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; }
        .btn-success { background: white; color: #059669; border: 1px solid #a7f3d0; }
        .btn-success:hover { background: #ecfdf5; border-color: #34d399; }
        .btn-warning { background: white; color: #d97706; border: 1px solid #fcd34d; }
        .btn-warning:hover { background: #fffbeb; border-color: #fbbf24; }
        .btn-danger { background: white; color: #dc2626; border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fef2f2; border-color: #f87171; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-confirm { background: white; color: #059669; border: 1px solid #a7f3d0; }
        .btn-confirm:hover { background: #ecfdf5; border-color: #34d399; }
        .btn-to-vocab { background: #eff6ff; color: #2563eb; border: 1px solid #93c5fd; }
        .btn-to-vocab:hover { background: #dbeafe; border-color: #60a5fa; }
        .vocab-opt { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 16px 8px; border: 2px solid #e5e7eb; border-radius: 12px; 
            cursor: pointer; text-align: center; transition: all 0.15s;
        }
        .vocab-opt:hover { border-color: #93c5fd; }
        .vocab-opt.selected { border-color: #2563eb; background: #eff6ff; }
        
        .item-list { background: transparent; border-radius: 12px; }
        
        .grammar-item { 
            padding: 16px; 
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 12px;
            transition: background 0.1s, box-shadow 0.1s;
            position: relative;
        }
        .grammar-item:last-child { margin-bottom: 0; }
        .grammar-item:hover { background: #fafafa; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .grammar-item.is-new { background: #fffbfb; border: 1.5px solid #fca5a5; }
        .grammar-item.is-new:hover { background: #fef7f7; }
        .grammar-item.disabled { opacity: 0.5; }
        
        .grammar-title { 
            font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 6px;
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
        }
        .grammar-definition { color: #666; font-size: 14px; margin-bottom: 8px; }
        .grammar-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .tag { background: #f3f4f6; color: #374151; padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        .grammar-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        
        .new-badge {
            position: absolute; top: 8px; right: 12px;
            background: white; color: #dc2626;
            font-size: 12px; font-weight: 600; padding: 4px 12px; 
            border-radius: 6px; border: 1px solid #fecaca;
        }
        .category-badge {
            display: inline-block; background: #ede9fe; color: #6d28d9;
            font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 4px;
        }
        
        .empty-state { text-align: center; padding: 48px 24px; color: #9ca3af; }
        .empty-state h3 { font-size: 16px; font-weight: 500; color: #666; margin-bottom: 8px; }
        .loading { text-align: center; padding: 48px; color: #9ca3af; }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination-wrap {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: white; border-top: 1px solid #e5e5e5;
            border-radius: 0 0 12px 12px; flex-wrap: wrap; gap: 12px;
        }
        .pagination-info { font-size: 13px; color: #6b7280; }
        .pagination-nav { display: flex; gap: 4px; align-items: center; }
        .page-btn {
            min-width: 36px; height: 36px; padding: 0 12px;
            border: 1px solid #e5e5e5; background: white; border-radius: 8px;
            font-size: 13px; cursor: pointer; transition: all 0.15s; color: #374151;
        }
        .page-btn:hover:not(:disabled) { background: #f3f4f6; border-color: #d1d5db; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background: #7c3aed; color: white; border-color: #7c3aed; }
        .page-size-select {
            padding: 8px 12px; border: 1px solid #e5e5e5; border-radius: 8px;
            font-size: 13px; background: white; cursor: pointer;
        }
        .page-size-select:focus { border-color: #7c3aed; outline: none; }
        
        .modal { 
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center;
            justify-content: center; padding: 24px;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; border-radius: 12px; width: 100%; 
            max-width: 900px; max-height: 95vh; overflow-y: auto;
        }
        .modal-header { 
            padding: 20px 24px; border-bottom: 1px solid #e5e5e5;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: white; z-index: 10;
        }
        .modal-header h2 { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #9ca3af; }
        .modal-body { padding: 24px; }
        .modal-footer { 
            padding: 16px 24px; border-top: 1px solid #e5e5e5; display: flex; justify-content: flex-end; gap: 8px;
            position: sticky; bottom: 0; background: white; z-index: 10;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px 14px; border: 1px solid #e5e5e5; 
            border-radius: 8px; font-size: 14px; outline: none; line-height: 1.5;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #7c3aed; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        
        .array-input { background: #f9fafb; border-radius: 8px; padding: 12px; margin-top: 8px; border: 1px solid #e5e7eb; }
        .array-item { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .array-item input, .array-item textarea { flex: 1; }
        .array-item textarea { min-height: 60px; resize: vertical; }
        .array-item:last-child { margin-bottom: 0; }
        
        .sub-topics-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
        .sub-topic-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .sub-topic-card:last-child { margin-bottom: 0; }
        .sub-topic-title { font-weight: 600; color: #374151; margin-bottom: 8px; }
        .sub-topic-content { font-size: 13px; color: #6b7280; line-height: 1.6; }
        
        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: #1a1a1a; color: white;
            border-radius: 8px; font-size: 14px; z-index: 2000;
            opacity: 0; transition: opacity 0.2s;
        }
        .toast.show { opacity: 1; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        
        @media (max-width: 768px) {
            body { padding: 12px; }
            .grammar-item { padding: 12px; }
            .grammar-actions { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin" class="back-link">â† è¿”å›ç®¡ç†åå°</a>
        
        <div class="header">
            <h1>ğŸ“š è¯­æ³•åº“ç®¡ç†</h1>
            <p>ç®¡ç†åˆä¸­è‹±è¯­è¯­æ³•çŸ¥è¯†åº“ï¼Œæ”¯æŒæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤è¯­æ³•ç‚¹</p>
            <div class="stats-bar">
                <div class="stat-item"><strong id="statTotal">0</strong> æ€»æ•°</div>
                <div class="stat-item"><strong id="statEnabled">0</strong> å·²å¯ç”¨</div>
                <div class="stat-item"><strong id="statDisabled">0</strong> å·²ç¦ç”¨</div>
                <div class="stat-item" style="background: #fef2f2; border-color: #fecaca;"><strong id="statNew" style="color: #dc2626;">0</strong> å¾…ç¡®è®¤</div>
                <div class="stat-item"><strong id="statSubTopics">0</strong> å­è¯é¢˜</div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨ Tab -->
        <div class="tabs" id="categoryTabs">
            <button class="tab-btn active" data-category="" onclick="switchCategory(this)">ğŸ“‹ å…¨éƒ¨</button>
            <!-- åŠ¨æ€åŠ è½½åˆ†ç±» Tab -->
        </div>
        
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchKeyword" placeholder="æœç´¢è¯­æ³•ç‚¹..." onkeypress="if(event.key==='Enter')searchGrammar()">
                <button class="btn btn-primary" onclick="searchGrammar()">æœç´¢</button>
            </div>
            <select class="page-size-select" id="pageSize" onchange="changePageSize()">
                <option value="50">50æ¡/é¡µ</option>
                <option value="100" selected>100æ¡/é¡µ</option>
                <option value="200">200æ¡/é¡µ</option>
                <option value="300">300æ¡/é¡µ</option>
                <option value="0">å…¨éƒ¨</option>
            </select>
            <button class="btn btn-success" onclick="openAddModal()">+ æ·»åŠ è¯­æ³•</button>
            <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡º</button>
            <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">å¯¼å…¥</button>
        </div>
        
        <div class="item-list" id="grammarList">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div class="pagination-wrap" id="paginationWrap" style="display:none;">
            <div class="pagination-info" id="pageInfo">å…± 0 æ¡</div>
            <div class="pagination-nav" id="pageNav"></div>
        </div>
        
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>

    <!-- è¯­æ³•ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="grammarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ è¯­æ³•</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="grammarId">
                <div class="form-group">
                    <label>æ ‡é¢˜ *</label>
                    <input type="text" id="grammarTitle" placeholder="è¯­æ³•ç‚¹åç§°">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="grammarCategory">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                        <option value="æ—¶æ€">æ—¶æ€</option>
                        <option value="ä»å¥">ä»å¥</option>
                        <option value="å¥å¼">å¥å¼</option>
                        <option value="è¯æ³•">è¯æ³•</option>
                        <option value="è¯­æ€">è¯­æ€</option>
                        <option value="è¯æ±‡è¾¨æ">è¯æ±‡è¾¨æ</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å®šä¹‰</label>
                    <textarea id="grammarDefinition" placeholder="è¯­æ³•ç‚¹çš„å®šä¹‰è¯´æ˜"></textarea>
                </div>
                <div class="form-group">
                    <label>ç»“æ„</label>
                    <textarea id="grammarStructure" placeholder="è¯­æ³•ç»“æ„"></textarea>
                </div>
                <div class="form-group">
                    <label>å…³é”®è¯ <span style="font-weight: normal; color: #9ca3af; font-size: 12px;">ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</span></label>
                    <textarea id="keywordsInput" placeholder="å…³é”®è¯1&#10;å…³é”®è¯2&#10;å…³é”®è¯3" style="min-height: 80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>ç”¨æ³• <span style="font-weight: normal; color: #9ca3af; font-size: 12px;">ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</span></label>
                    <textarea id="usageInput" placeholder="ç”¨æ³•è¯´æ˜1&#10;ç”¨æ³•è¯´æ˜2" style="min-height: 80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¾‹å¥ <span style="font-weight: normal; color: #9ca3af; font-size: 12px;">ï¼ˆæ¯è¡Œä¸€å¥ï¼‰</span></label>
                    <textarea id="examplesInput" placeholder="ä¾‹å¥1&#10;ä¾‹å¥2" style="min-height: 80px;"></textarea>
                </div>
                <!-- å­è¯é¢˜æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="sub-topics-section" id="subTopicsSection" style="display: none;">
                    <label style="font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 12px; display: block;">ğŸ“š å­è¯é¢˜</label>
                    <div id="subTopicsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveGrammar()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- è½¬ç§»å¼¹çª— -->
    <div class="modal" id="transferModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>è½¬ç§»è¯­æ³•ç‚¹</h2>
                <button class="modal-close" onclick="closeTransferModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <div style="font-size: 13px; color: #92400e;">
                        å°† <strong id="transferSourceTitle"></strong> çš„å†…å®¹è½¬ç§»åˆ°ç›®æ ‡è¯­æ³•ç‚¹ï¼Œä½œä¸ºå­è¯é¢˜
                    </div>
                </div>
                <input type="hidden" id="transferSourceId">
                <div class="form-group">
                    <label>æœç´¢ç›®æ ‡è¯­æ³•ç‚¹</label>
                    <input type="text" id="transferSearchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." oninput="searchTransferTarget()">
                </div>
                <div id="transferSearchResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; display: none;"></div>
                <div id="transferSelectedTarget" style="display: none; margin-top: 12px; padding: 12px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">å·²é€‰æ‹©ç›®æ ‡ï¼š</div>
                    <div style="font-weight: 600; color: #065f46;" id="transferTargetTitle"></div>
                    <input type="hidden" id="transferTargetId">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="transferDeleteSource" checked>
                        <span>è½¬ç§»ååˆ é™¤åŸè¯­æ³•ç‚¹</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTransferModal()">å–æ¶ˆ</button>
                <button class="btn btn-warning" onclick="executeTransfer()">ç¡®è®¤è½¬ç§»</button>
            </div>
        </div>
    </div>

    <!-- è½¬ç§»åˆ°è¯åº“å¼¹çª— -->
    <div class="modal" id="toVocabModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2>è½¬ç§»åˆ°è¯åº“</h2>
                <button class="modal-close" onclick="closeToVocabModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <div style="font-size: 12px; color: #1d4ed8; margin-bottom: 4px;">è¦è½¬ç§»çš„è¯­æ³•ç‚¹</div>
                    <div style="font-weight: 600; color: #1e40af;" id="toVocabTitle"></div>
                </div>
                <input type="hidden" id="toVocabId">
                <div class="form-group">
                    <label>é€‰æ‹©ç›®æ ‡åº“</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;" id="vocabTargetOptions">
                        <label class="vocab-opt" data-value="word" onclick="selectVocabTarget('word')">
                            <input type="radio" name="vocabTarget" value="word" style="display:none">
                            <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“</div>
                            <div style="font-weight: 600; color: #1f2937;">å•è¯åº“</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">é€‚åˆå•ä¸ªè¯æ±‡</div>
                        </label>
                        <label class="vocab-opt" data-value="phrase" onclick="selectVocabTarget('phrase')">
                            <input type="radio" name="vocabTarget" value="phrase" style="display:none">
                            <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“–</div>
                            <div style="font-weight: 600; color: #1f2937;">çŸ­è¯­åº“</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">é€‚åˆå›ºå®šæ­é…</div>
                        </label>
                        <label class="vocab-opt selected" data-value="pattern" onclick="selectVocabTarget('pattern')">
                            <input type="radio" name="vocabTarget" value="pattern" checked style="display:none">
                            <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“‹</div>
                            <div style="font-weight: 600; color: #1f2937;">å¥å‹åº“</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">é€‚åˆå¥å‹ç»“æ„</div>
                        </label>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="toVocabDelete" checked>
                        <span>è½¬ç§»ååˆ é™¤åŸè¯­æ³•ç‚¹</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeToVocabModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="executeToVocab()">ç¡®è®¤è½¬ç§»</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/grammar';
        let allGrammar = [];
        let currentCategory = '';
        
        // åˆ†é¡µçŠ¶æ€
        const pagination = { page: 1, pageSize: 100, total: 0, data: [] };

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadCategories();
            loadGrammar();
        });

        async function loadStats() {
            try {
                const res = await fetch(API_BASE + '/stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('statTotal').textContent = data.data.total;
                    document.getElementById('statEnabled').textContent = data.data.enabled;
                    document.getElementById('statDisabled').textContent = data.data.disabled;
                    // v2.1: æ˜¾ç¤ºæ–°å¢æ•°é‡
                    document.getElementById('statNew').textContent = data.data.newCount || 0;
                    // v2.0: æ˜¾ç¤ºå­è¯é¢˜æ€»æ•°
                    document.getElementById('statSubTopics').textContent = data.data.totalSubTopics || 0;
                }
            } catch (e) { console.error(e); }
        }

        async function loadCategories() {
            try {
                const res = await fetch(API_BASE + '/categories');
                const data = await res.json();
                if (data.success && data.data.length) {
                    const tabsContainer = document.getElementById('categoryTabs');
                    const selectEl = document.getElementById('grammarCategory');
                    
                    // æ¸…ç©ºä¸‹æ‹‰æ¡†ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
                    selectEl.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»</option>';
                    
                    // API è¿”å›çš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„
                    data.data.forEach(cat => {
                        // æ·»åŠ  Tab æŒ‰é’®
                        const btn = document.createElement('button');
                        btn.className = 'tab-btn';
                        btn.dataset.category = cat;
                        btn.onclick = function() { switchCategory(this); };
                        btn.textContent = cat;
                        tabsContainer.appendChild(btn);
                        
                        // æ·»åŠ ä¸‹æ‹‰é€‰é¡¹
                        const opt = document.createElement('option');
                        opt.value = cat;
                        opt.textContent = cat;
                        selectEl.appendChild(opt);
                    });
                }
            } catch (e) { console.error(e); }
        }

        function switchCategory(btn) {
            // æ›´æ–° Tab æ ·å¼
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // å‰ç«¯è¿‡æ»¤
            currentCategory = btn.dataset.category;
            pagination.page = 1; // åˆ‡æ¢åˆ†ç±»é‡ç½®é¡µç 
            filterAndRender();
        }

        // å‰ç«¯è¿‡æ»¤å¹¶æ¸²æŸ“
        function filterAndRender() {
            const filtered = currentCategory 
                ? allGrammar.filter(g => g.category === currentCategory)
                : allGrammar;
            pagination.data = filtered;
            pagination.total = filtered.length;
            renderPaginated();
        }
        
        // åˆ‡æ¢æ¯é¡µæ¡æ•°
        function changePageSize() {
            pagination.pageSize = parseInt(document.getElementById('pageSize').value) || 0;
            pagination.page = 1;
            renderPaginated();
        }
        
        // è·³è½¬é¡µç 
        function goToPage(page) {
            const totalPages = pagination.pageSize === 0 ? 1 : Math.ceil(pagination.total / pagination.pageSize);
            if (page < 1 || page > totalPages) return;
            pagination.page = page;
            renderPaginated();
        }
        
        // æ¸²æŸ“åˆ†é¡µæ•°æ®
        function renderPaginated() {
            const { data, page, pageSize, total } = pagination;
            let displayData;
            if (pageSize === 0) {
                displayData = data;
            } else {
                const start = (page - 1) * pageSize;
                displayData = data.slice(start, start + pageSize);
            }
            renderGrammar(displayData);
            renderPaginationNav();
        }
        
        // æ¸²æŸ“åˆ†é¡µå¯¼èˆª
        function renderPaginationNav() {
            const { total, pageSize, page } = pagination;
            const paginationEl = document.getElementById('paginationWrap');
            const infoEl = document.getElementById('pageInfo');
            const navEl = document.getElementById('pageNav');
            
            if (total === 0) {
                paginationEl.style.display = 'none';
                return;
            }
            
            paginationEl.style.display = 'flex';
            
            if (pageSize === 0 || total <= pageSize) {
                infoEl.textContent = `å…± ${total} æ¡`;
                navEl.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(total / pageSize);
            const start = (page - 1) * pageSize + 1;
            const end = Math.min(page * pageSize, total);
            
            infoEl.textContent = `ç¬¬ ${start}-${end} æ¡ï¼Œå…± ${total} æ¡`;
            
            let navHtml = `<button class="page-btn" onclick="goToPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            const maxButtons = 5;
            let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);
            
            if (startPage > 1) {
                navHtml += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) navHtml += `<span style="padding:0 8px;color:#9ca3af;">...</span>`;
            }
            for (let i = startPage; i <= endPage; i++) {
                navHtml += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) navHtml += `<span style="padding:0 8px;color:#9ca3af;">...</span>`;
                navHtml += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            navHtml += `<button class="page-btn" onclick="goToPage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            navEl.innerHTML = navHtml;
        }

        async function loadGrammar() {
            try {
                document.getElementById('grammarList').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                const res = await fetch(API_BASE + '?all=true');
                const data = await res.json();
                if (data.success) {
                    allGrammar = data.data;
                    filterAndRender();
                }
            } catch (e) {
                document.getElementById('grammarList').innerHTML = '<div class="empty-state"><h3>åŠ è½½å¤±è´¥</h3></div>';
            }
        }

        function renderGrammar(items) {
            const c = document.getElementById('grammarList');
            if (!items.length) {
                c.innerHTML = '<div class="empty-state"><h3>æš‚æ— è¯­æ³•ç‚¹</h3><p>ç‚¹å‡»"æ·»åŠ è¯­æ³•"åˆ›å»º</p></div>';
                return;
            }
            
            c.innerHTML = items.map(g => {
                const isNew = g.is_new === true || g.is_new === 1;
                const keywords = g.keywords ? (typeof g.keywords === 'string' ? JSON.parse(g.keywords) : g.keywords) : [];
                // v2.0: è·å–å­è¯é¢˜
                const subTopics = g.sub_topics ? (typeof g.sub_topics === 'string' ? JSON.parse(g.sub_topics) : g.sub_topics) : [];
                const hasSubTopics = subTopics.length > 0;
                
                return `
                <div class="grammar-item ${g.enabled ? '' : 'disabled'} ${isNew ? 'is-new' : ''}">
                    ${isNew ? '<span class="new-badge">æ–°</span>' : ''}
                    <div class="grammar-title">
                        ${escapeHtml(g.title)}
                        ${g.category ? `<span class="category-badge">${escapeHtml(g.category)}</span>` : ''}
                        ${hasSubTopics ? `<span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">ğŸ“š ${subTopics.length} ä¸ªå­è¯é¢˜</span>` : ''}
                    </div>
                    <div class="grammar-definition">${escapeHtml(g.definition || '')}</div>
                    ${keywords.length ? `
                        <div class="grammar-tags">
                            ${keywords.slice(0, 6).map(k => `<span class="tag">${escapeHtml(k)}</span>`).join('')}
                            ${keywords.length > 6 ? `<span class="tag">+${keywords.length - 6}</span>` : ''}
                        </div>
                    ` : ''}
                    ${hasSubTopics ? `
                        <div style="margin-top: 12px; background: #f9fafb; border-radius: 8px; padding: 12px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px; font-weight: 500;">ğŸ“š ç›¸å…³çŸ¥è¯†ç‚¹ (${subTopics.length})</div>
                            ${subTopics.map((st, idx) => `
                                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e5e7eb; ${idx === subTopics.length - 1 ? 'margin-bottom: 0;' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #374151; margin-bottom: 6px;">${idx + 1}. ${escapeHtml(st.title)}</div>
                                            ${st.definition ? `<div style="font-size: 13px; color: #4b5563; margin-bottom: 6px; line-height: 1.5;">${escapeHtml(st.definition)}</div>` : ''}
                                            ${st.structure ? `<div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;"><span style="color: #9ca3af;">ç»“æ„ï¼š</span>${escapeHtml(st.structure)}</div>` : ''}
                                            ${st.examples && st.examples.length > 0 ? `<div style="font-size: 13px; color: #6b7280;"><span style="color: #9ca3af;">ä¾‹å¥ï¼š</span>${st.examples.map(e => escapeHtml(e)).join(' / ')}</div>` : ''}
                                        </div>
                                        <button class="btn btn-danger btn-sm" onclick="removeSubTopic(${g.id}, ${idx}, '${escapeHtml(st.title).replace(/'/g, "\\'")}', event)" style="font-size: 11px; padding: 3px 8px;">åˆ é™¤</button>
                                    </div>
                                    ${st.added_at ? `<div style="font-size: 11px; color: #9ca3af; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e5e7eb;">æ·»åŠ äº ${formatTime(st.added_at)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="grammar-actions" style="${hasSubTopics ? 'margin-top: 10px;' : ''}">
                        ${isNew ? `<button class="btn btn-confirm btn-sm" onclick="confirmGrammar(${g.id})">âœ“ ç¡®è®¤</button>` : ''}
                        <button class="btn btn-primary btn-sm" onclick="editGrammar(${g.id})">ç¼–è¾‘</button>
                        <button class="btn btn-warning btn-sm" onclick="openTransferModal(${g.id}, '${escapeHtml(g.title).replace(/'/g, "\\'")}')">è½¬ç§»</button>
                        <button class="btn btn-to-vocab btn-sm" onclick="openToVocabModal(${g.id}, '${escapeHtml(g.title).replace(/'/g, "\\'")}')">è½¬ç§»</button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleGrammar(${g.id})">${g.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteGrammar(${g.id}, '${escapeHtml(g.title)}')">åˆ é™¤</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function searchGrammar() {
            const kw = document.getElementById('searchKeyword').value.trim();
            if (!kw) {
                filterAndRender();
                return;
            }
            try {
                document.getElementById('grammarList').innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
                const res = await fetch(API_BASE + '/search?keyword=' + encodeURIComponent(kw));
                const data = await res.json();
                if (data.success) {
                    pagination.data = data.data;
                    pagination.total = data.data.length;
                    pagination.page = 1;
                    renderPaginated();
                }
            } catch (e) { console.error(e); }
        }

        async function confirmGrammar(id) {
            try {
                const res = await fetch(API_BASE + '/' + id + '/confirm', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('å·²ç¡®è®¤', 'success');
                    loadGrammar();
                    loadStats();
                }
            } catch (e) { showToast('æ“ä½œå¤±è´¥', 'error'); }
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ è¯­æ³•';
            document.getElementById('grammarId').value = '';
            document.getElementById('grammarTitle').value = '';
            document.getElementById('grammarCategory').value = currentCategory || '';
            document.getElementById('grammarDefinition').value = '';
            document.getElementById('grammarStructure').value = '';
            
            // æ¸…ç©ºtextarea
            document.getElementById('keywordsInput').value = '';
            document.getElementById('usageInput').value = '';
            document.getElementById('examplesInput').value = '';
            
            // éšè—å­è¯é¢˜åŒºåŸŸ
            document.getElementById('subTopicsSection').style.display = 'none';
            document.getElementById('subTopicsList').innerHTML = '';
            
            document.getElementById('grammarModal').classList.add('active');
        }

        async function editGrammar(id) {
            try {
                const res = await fetch(API_BASE + '/' + id);
                const data = await res.json();
                if (data.success) {
                    const g = data.data;
                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è¯­æ³•';
                    document.getElementById('grammarId').value = g.id;
                    document.getElementById('grammarTitle').value = g.title || '';
                    document.getElementById('grammarCategory').value = g.category || '';
                    document.getElementById('grammarDefinition').value = g.definition || '';
                    document.getElementById('grammarStructure').value = g.structure || '';
                    
                    // å¡«å……textareaï¼ˆæ•°ç»„è½¬æ¢ä¸ºæ¯è¡Œä¸€æ¡ï¼‰
                    document.getElementById('keywordsInput').value = arrayToLines(g.keywords);
                    document.getElementById('usageInput').value = arrayToLines(g.usage);
                    document.getElementById('examplesInput').value = arrayToLines(g.examples);
                    
                    // æ˜¾ç¤ºå­è¯é¢˜ï¼ˆå¯ç¼–è¾‘ï¼‰
                    const subTopics = g.sub_topics || [];
                    const subTopicsSection = document.getElementById('subTopicsSection');
                    const subTopicsList = document.getElementById('subTopicsList');
                    
                    if (subTopics.length > 0) {
                        subTopicsSection.style.display = 'block';
                        subTopicsList.innerHTML = subTopics.map((st, idx) => `
                            <div class="sub-topic-card" data-index="${idx}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-weight: 600; color: #374151;">å­è¯é¢˜ ${idx + 1}</span>
                                    <button class="btn btn-danger btn-sm" onclick="removeSubTopicInEdit(${idx})">åˆ é™¤</button>
                                </div>
                                <div style="display: grid; gap: 10px;">
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">æ ‡é¢˜</label>
                                        <input type="text" class="sub-topic-input" data-field="title" data-index="${idx}" value="${escapeHtml(st.title || '')}" style="width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">å®šä¹‰</label>
                                        <textarea class="sub-topic-input" data-field="definition" data-index="${idx}" style="width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${escapeHtml(st.definition || '')}</textarea>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">ç»“æ„</label>
                                        <input type="text" class="sub-topic-input" data-field="structure" data-index="${idx}" value="${escapeHtml(st.structure || '')}" style="width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">ä¾‹å¥ <span style="font-weight: normal; color: #9ca3af;">ï¼ˆæ¯è¡Œä¸€å¥ï¼‰</span></label>
                                        <textarea class="sub-topic-input" data-field="examples" data-index="${idx}" style="width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${escapeHtml((st.examples || []).join('\n'))}</textarea>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">ç”¨æ³• <span style="font-weight: normal; color: #9ca3af;">ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</span></label>
                                        <textarea class="sub-topic-input" data-field="usage" data-index="${idx}" style="width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${escapeHtml((st.usage || []).join('\n'))}</textarea>
                                    </div>
                                </div>
                                ${st.added_at ? `<div style="font-size: 11px; color: #9ca3af; margin-top: 10px;">æ·»åŠ äº ${formatTime(st.added_at)}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        subTopicsSection.style.display = 'none';
                        subTopicsList.innerHTML = '';
                    }
                    
                    document.getElementById('grammarModal').classList.add('active');
                }
            } catch (e) { showToast('åŠ è½½å¤±è´¥', 'error'); }
        }

        async function saveGrammar() {
            const id = document.getElementById('grammarId').value;
            const title = document.getElementById('grammarTitle').value.trim();
            const category = document.getElementById('grammarCategory').value.trim();
            const definition = document.getElementById('grammarDefinition').value.trim();
            const structure = document.getElementById('grammarStructure').value.trim();
            const keywords = getTextareaArray('keywordsInput');
            const usage = getTextareaArray('usageInput');
            const examples = getTextareaArray('examplesInput');
            
            // æ”¶é›†å­è¯é¢˜æ•°æ®
            const sub_topics = getSubTopicsData();

            if (!title) {
                showToast('æ ‡é¢˜å¿…å¡«', 'error');
                return;
            }

            try {
                const url = id ? API_BASE + '/' + id : API_BASE;
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, category, definition, structure, keywords, usage, examples, sub_topics })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(id ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                    closeModal();
                    loadStats();
                    loadGrammar();
                    loadCategories();
                }
            } catch (e) { showToast('ä¿å­˜å¤±è´¥', 'error'); }
        }

        async function toggleGrammar(id) {
            try {
                const res = await fetch(API_BASE + '/' + id + '/toggle', { method: 'PATCH' });
                const data = await res.json();
                if (data.success) {
                    showToast('çŠ¶æ€å·²åˆ‡æ¢', 'success');
                    loadStats();
                    loadGrammar();
                }
            } catch (e) { showToast('æ“ä½œå¤±è´¥', 'error'); }
        }

        async function deleteGrammar(id, title) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${title}"å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(API_BASE + '/' + id, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    loadStats();
                    loadGrammar();
                    loadCategories();
                }
            } catch (e) { showToast('åˆ é™¤å¤±è´¥', 'error'); }
        }

        async function exportData() {
            try {
                const res = await fetch(API_BASE + '/export');
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grammar_export.json';
                a.click();
                showToast('å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (e) { showToast('å¯¼å‡ºå¤±è´¥', 'error'); }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const res = await fetch(API_BASE + '/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: text
                });
                const data = await res.json();
                if (data.success) {
                    showToast('å¯¼å…¥æˆåŠŸ', 'success');
                    loadStats();
                    loadGrammar();
                    loadCategories();
                }
            } catch (e) { showToast('å¯¼å…¥å¤±è´¥', 'error'); }
            event.target.value = '';
        }

        // Textareaè¾…åŠ©å‡½æ•° - æ•°ç»„è½¬æ¯è¡Œä¸€æ¡
        function arrayToLines(arr) {
            if (!arr) return '';
            if (typeof arr === 'string') {
                try { arr = JSON.parse(arr); } catch { return arr; }
            }
            return arr.filter(v => v).join('\n');
        }
        
        // Textareaè¾…åŠ©å‡½æ•° - æ¯è¡Œè½¬æ•°ç»„
        function getTextareaArray(textareaId) {
            const text = document.getElementById(textareaId).value;
            return text.split('\n').map(line => line.trim()).filter(line => line);
        }
        
        // æ”¶é›†å­è¯é¢˜æ•°æ®
        function getSubTopicsData() {
            const cards = document.querySelectorAll('#subTopicsList .sub-topic-card');
            const subTopics = [];
            
            cards.forEach(card => {
                const idx = card.dataset.index;
                const title = card.querySelector(`[data-field="title"][data-index="${idx}"]`)?.value?.trim() || '';
                const definition = card.querySelector(`[data-field="definition"][data-index="${idx}"]`)?.value?.trim() || '';
                const structure = card.querySelector(`[data-field="structure"][data-index="${idx}"]`)?.value?.trim() || '';
                const examplesStr = card.querySelector(`[data-field="examples"][data-index="${idx}"]`)?.value?.trim() || '';
                const usageStr = card.querySelector(`[data-field="usage"][data-index="${idx}"]`)?.value?.trim() || '';
                
                // æŒ‰æ¢è¡Œåˆ†å‰²æˆæ•°ç»„
                const examples = examplesStr ? examplesStr.split('\n').map(e => e.trim()).filter(e => e) : [];
                const usage = usageStr ? usageStr.split('\n').map(u => u.trim()).filter(u => u) : [];
                
                if (title) {
                    subTopics.push({
                        title,
                        definition,
                        structure,
                        examples,
                        usage,
                        added_at: card.querySelector('[style*="æ·»åŠ äº"]')?.textContent?.replace('æ·»åŠ äº ', '') || new Date().toISOString()
                    });
                }
            });
            
            return subTopics;
        }
        
        // åœ¨ç¼–è¾‘ç•Œé¢åˆ é™¤å­è¯é¢˜
        function removeSubTopicInEdit(idx) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå­è¯é¢˜å—ï¼Ÿ')) return;
            const card = document.querySelector(`#subTopicsList .sub-topic-card[data-index="${idx}"]`);
            if (card) {
                card.remove();
                // é‡æ–°ç¼–å·
                const cards = document.querySelectorAll('#subTopicsList .sub-topic-card');
                if (cards.length === 0) {
                    document.getElementById('subTopicsSection').style.display = 'none';
                } else {
                    cards.forEach((c, i) => {
                        c.dataset.index = i;
                        c.querySelector('span').textContent = `å­è¯é¢˜ ${i + 1}`;
                        c.querySelectorAll('.sub-topic-input').forEach(input => {
                            input.dataset.index = i;
                        });
                    });
                }
            }
        }

        function closeModal() {
            document.getElementById('grammarModal').classList.remove('active');
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 2500);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // v2.0: å­è¯é¢˜ç›¸å…³å‡½æ•°
        // ============================================
        
        /**
         * åˆ‡æ¢å­è¯é¢˜å±•å¼€/æŠ˜å 
         */
        function toggleSubTopics(grammarId) {
            const container = document.getElementById('subTopics_' + grammarId);
            const btn = document.getElementById('subTopicsBtn_' + grammarId);
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.textContent = btn.textContent.replace('å±•å¼€', 'æ”¶èµ·').replace('ğŸ“–', 'ğŸ“•');
            } else {
                container.style.display = 'none';
                btn.textContent = btn.textContent.replace('æ”¶èµ·', 'å±•å¼€').replace('ğŸ“•', 'ğŸ“–');
            }
        }
        
        /**
         * åˆ é™¤å­è¯é¢˜
         */
        async function removeSubTopic(grammarId, subTopicIndex, subTopicTitle, event) {
            event.stopPropagation();
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å­è¯é¢˜ã€Œ${subTopicTitle}ã€å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(API_BASE + '/' + grammarId + '/sub-topic/' + subTopicIndex, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('å­è¯é¢˜å·²åˆ é™¤', 'success');
                    loadGrammar();
                    loadStats();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        /**
         * æ ¼å¼åŒ–æ—¶é—´
         */
        function formatTime(dateStr) {
            if (!dateStr) return '';
            
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                
                return `${month}/${day} ${hour}:${minute}`;
            } catch (e) {
                return dateStr;
            }
        }

        // ============================================
        // v2.2: è½¬ç§»/åˆå¹¶åŠŸèƒ½
        // ============================================
        
        let transferSourceData = null;
        
        function openTransferModal(sourceId, sourceTitle) {
            document.getElementById('transferSourceId').value = sourceId;
            document.getElementById('transferSourceTitle').textContent = sourceTitle;
            document.getElementById('transferSearchInput').value = '';
            document.getElementById('transferSearchResults').style.display = 'none';
            document.getElementById('transferSearchResults').innerHTML = '';
            document.getElementById('transferSelectedTarget').style.display = 'none';
            document.getElementById('transferTargetId').value = '';
            document.getElementById('transferDeleteSource').checked = true;
            
            // è·å–æºè¯­æ³•ç‚¹çš„å®Œæ•´æ•°æ®
            fetch(API_BASE + '/' + sourceId)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        transferSourceData = data.data;
                    }
                });
            
            document.getElementById('transferModal').classList.add('active');
        }
        
        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('active');
            transferSourceData = null;
        }
        
        let transferSearchTimeout = null;
        function searchTransferTarget() {
            clearTimeout(transferSearchTimeout);
            const keyword = document.getElementById('transferSearchInput').value.trim();
            const sourceId = document.getElementById('transferSourceId').value;
            
            if (!keyword) {
                document.getElementById('transferSearchResults').style.display = 'none';
                return;
            }
            
            transferSearchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(API_BASE + '/search?keyword=' + encodeURIComponent(keyword));
                    const data = await res.json();
                    
                    if (data.success && data.data.length > 0) {
                        // æ’é™¤è‡ªå·±
                        const results = data.data.filter(g => g.id != sourceId);
                        
                        if (results.length > 0) {
                            document.getElementById('transferSearchResults').innerHTML = results.map(g => `
                                <div style="padding: 10px 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background 0.1s;"
                                     onmouseover="this.style.background='#f9fafb'"
                                     onmouseout="this.style.background='white'"
                                     onclick="selectTransferTarget(${g.id}, '${escapeHtml(g.title).replace(/'/g, "\\'")}')">
                                    <div style="font-weight: 500; color: #374151;">${escapeHtml(g.title)}</div>
                                    <div style="font-size: 12px; color: #9ca3af;">${escapeHtml(g.definition || '').slice(0, 50)}...</div>
                                    ${g.sub_topics && g.sub_topics.length > 0 ? `<div style="font-size: 11px; color: #059669;">å·²æœ‰ ${g.sub_topics.length} ä¸ªå­è¯é¢˜</div>` : ''}
                                </div>
                            `).join('');
                            document.getElementById('transferSearchResults').style.display = 'block';
                        } else {
                            document.getElementById('transferSearchResults').innerHTML = '<div style="padding: 12px; color: #9ca3af; text-align: center;">æ²¡æœ‰æ‰¾åˆ°å…¶ä»–è¯­æ³•ç‚¹</div>';
                            document.getElementById('transferSearchResults').style.display = 'block';
                        }
                    } else {
                        document.getElementById('transferSearchResults').innerHTML = '<div style="padding: 12px; color: #9ca3af; text-align: center;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯­æ³•ç‚¹</div>';
                        document.getElementById('transferSearchResults').style.display = 'block';
                    }
                } catch (e) {
                    console.error(e);
                }
            }, 300);
        }
        
        function selectTransferTarget(targetId, targetTitle) {
            document.getElementById('transferTargetId').value = targetId;
            document.getElementById('transferTargetTitle').textContent = targetTitle;
            document.getElementById('transferSelectedTarget').style.display = 'block';
            document.getElementById('transferSearchResults').style.display = 'none';
            document.getElementById('transferSearchInput').value = targetTitle;
        }
        
        async function executeTransfer() {
            const sourceId = document.getElementById('transferSourceId').value;
            const targetId = document.getElementById('transferTargetId').value;
            const deleteSource = document.getElementById('transferDeleteSource').checked;
            
            if (!targetId) {
                showToast('è¯·é€‰æ‹©ç›®æ ‡è¯­æ³•ç‚¹', 'error');
                return;
            }
            
            if (!transferSourceData) {
                showToast('æºæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                return;
            }
            
            try {
                // æ„å»ºå­è¯é¢˜æ•°æ®
                const subTopic = {
                    title: transferSourceData.title,
                    definition: transferSourceData.definition || '',
                    structure: transferSourceData.structure || '',
                    examples: transferSourceData.examples || [],
                    usage: transferSourceData.usage || [],
                    mistakes: transferSourceData.mistakes || [],
                    source_type: 'transfer',
                    source_id: sourceId
                };
                
                // æ·»åŠ å­è¯é¢˜åˆ°ç›®æ ‡
                const addRes = await fetch(API_BASE + '/' + targetId + '/sub-topic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subTopic)
                });
                const addData = await addRes.json();
                
                if (!addData.success) {
                    showToast('è½¬ç§»å¤±è´¥: ' + (addData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    return;
                }
                
                // å¦‚æœå‹¾é€‰äº†åˆ é™¤æº
                if (deleteSource) {
                    await fetch(API_BASE + '/' + sourceId, { method: 'DELETE' });
                }
                
                showToast('è½¬ç§»æˆåŠŸï¼', 'success');
                closeTransferModal();
                loadStats();
                loadGrammar();
                
            } catch (e) {
                showToast('è½¬ç§»å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // ============================================
        // è½¬ç§»åˆ°è¯åº“åŠŸèƒ½
        // ============================================
        
        function openToVocabModal(id, title) {
            document.getElementById('toVocabId').value = id;
            document.getElementById('toVocabTitle').textContent = title;
            document.getElementById('toVocabDelete').checked = true;
            selectVocabTarget('pattern'); // é»˜è®¤é€‰ä¸­å¥å‹
            document.getElementById('toVocabModal').classList.add('active');
        }
        
        function selectVocabTarget(type) {
            document.querySelectorAll('.vocab-opt').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input').checked = false;
            });
            const target = document.querySelector(`.vocab-opt[data-value="${type}"]`);
            if (target) {
                target.classList.add('selected');
                target.querySelector('input').checked = true;
            }
        }
        
        function closeToVocabModal() {
            document.getElementById('toVocabModal').classList.remove('active');
        }
        
        async function executeToVocab() {
            const id = document.getElementById('toVocabId').value;
            const targetType = document.querySelector('input[name="vocabTarget"]:checked')?.value;
            const deleteSource = document.getElementById('toVocabDelete').checked;
            
            if (!targetType) {
                showToast('è¯·é€‰æ‹©ç›®æ ‡åº“', 'error');
                return;
            }
            
            const targetNames = { word: 'å•è¯åº“', phrase: 'çŸ­è¯­åº“', pattern: 'å¥å‹åº“' };
            if (!confirm(`ç¡®å®šè¦å°†æ­¤è¯­æ³•ç‚¹è½¬ç§»åˆ°ã€${targetNames[targetType]}ã€‘å—ï¼Ÿ${deleteSource ? '\n\nè½¬ç§»ååŸè¯­æ³•ç‚¹å°†è¢«åˆ é™¤ï¼' : ''}`)) {
                return;
            }
            
            try {
                const res = await fetch(API_BASE + '/' + id + '/transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetType, deleteSource })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('è½¬ç§»æˆåŠŸï¼', 'success');
                    closeToVocabModal();
                    loadStats();
                    loadGrammar();
                } else {
                    showToast('è½¬ç§»å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showToast('è½¬ç§»å¤±è´¥: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>